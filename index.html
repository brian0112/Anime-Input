<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å‹•ç•«é€²åº¦</title>
    <meta name="description" content="ç™»è¨˜å‹•ç•«ã€è¼¸å…¥è§€çœ‹ç´€éŒ„ã€é€±æ¬¡ç¸½è¦½èˆ‡åŒ¯å‡ºã€‚"/>
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <meta property="og:title" content="å‹•ç•«é€²åº¦" />
    <meta property="og:description" content="ç™»è¨˜å‹•ç•«ã€è¼¸å…¥è§€çœ‹ç´€éŒ„ã€é€±æ¬¡ç¸½è¦½èˆ‡åŒ¯å‡ºã€‚"/>
    <meta property="og:type" content="website" />
    <style>
      .tabs { display:flex; gap:.5rem; flex-wrap:wrap; }
      .tabs a { text-decoration:none; }
      .hidden{ display:none !important }
      .stack{ display:grid; gap:1rem }
      .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap }
      .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
      .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem }
      .pill{ border:1px solid var(--border); padding:.25rem .6rem; border-radius:999px; font-size:.9rem; color:var(--muted)}
      .muted{ color:var(--muted) }
      .thumb{ width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:.75rem; border:1px solid var(--border); background:#0002 }
      .badge{ font-size:.8rem; padding:.2rem .5rem; border-radius:.5rem; border:1px solid var(--border); }
      .badge.complete{ background:var(--brand); color:var(--brand-ink); border-color:transparent; font-weight:700; }
      dialog{ border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:1rem; padding:1rem; max-width:560px }
      dialog::backdrop{ background: rgba(0,0,0,.4) }

      /* è‡ªè¨‚å‹•ç•«ä¸‹æ‹‰ï¼ˆå¸¶ç¸®åœ–ï¼‰ */
      .select-anime { position:relative; }
      .select-btn { width:100%; display:flex; align-items:center; justify-content:space-between; gap:.75rem; border:1px solid var(--border); background:transparent; color:var(--text); padding:.6rem .9rem; border-radius:.8rem; cursor:pointer; }
      .select-btn .left { display:flex; align-items:center; gap:.75rem; min-width:0; }
      .select-btn img { width:36px; height:36px; border-radius:.5rem; object-fit:cover; border:1px solid var(--border); }
      .select-btn .name { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .select-list { position:absolute; z-index:20; inset: auto 0 0 0; transform: translateY(100%); background:var(--panel); border:1px solid var(--border); border-radius:.8rem; padding:.4rem; max-height:300px; overflow:auto; box-shadow: 0 10px 30px #0005; }
      .select-item { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem .6rem; border-radius:.6rem; cursor:pointer; }
      .select-item:hover{ background:#ffffff10 }
      .select-item .left{ display:flex; align-items:center; gap:.6rem; }
      .select-item img { width:40px; height:40px; border-radius:.5rem; object-fit:cover; border:1px solid var(--border); }
      .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.8rem; padding:.1rem .35rem; border:1px solid var(--border); border-radius:.35rem; color:var(--muted) }

      /* é›†æ•¸æ§åˆ¶åˆ— */
      .range-row input[type="number"]{ width:6rem; }

      /* ç®¡ç†é å¡ç‰‡ï¼šå…©æ¬„ã€å·¦åœ–å³æ–‡ï¼Œå³ä¸Šç´…è‰²åƒåœ¾æ¡¶ */
      :root{ --danger:#ef4444; --danger-ink:#ffffff; }
      .manage-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:1rem }
      .manage-card{ display:grid; grid-template-columns: 1.3fr 1fr; gap:1rem; border:1px solid var(--border); background:var(--panel); border-radius:1rem; padding:1rem; position:relative; }
      .manage-card .thumb{ aspect-ratio:16/9; width:100%; }
      .manage-card .right{ display:grid; gap:.5rem; padding-right:2.4rem; } /* å³ä¸Šè§’ä¿ç•™ç©ºé–“çµ¦åƒåœ¾æ¡¶ */
      .manage-card .title-row{ display:flex; justify-content:space-between; gap:.75rem; align-items:flex-start }
      .icon-btn{ position:absolute; top:.6rem; right:.6rem; border:1px solid transparent; background:var(--danger); color:var(--danger-ink); border-radius:.6rem; padding:.45rem; cursor:pointer; z-index:2; box-shadow:0 4px 14px rgba(239,68,68,.35); }
      .icon-btn:hover{ filter:brightness(1.1) }
      .icon-trash{ width:18px; height:18px; display:block }
      .ellipsis-1{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }

      @media (max-width: 1024px){
        .two-col{ grid-template-columns:1fr }
        .grid-3{ grid-template-columns:1fr }
        .manage-grid{ grid-template-columns:1fr }
      }
    </style>
  </head>
  <body>
    <header class="site-header container">
      <a class="brand" href="#record" aria-label="é¦–é ">ğŸï¸ å‹•ç•«é€²åº¦</a>
      <nav class="nav tabs" aria-label="ä¸»é¸å–®">
        <a href="#record" class="pill">å‹•ç•«ç´€éŒ„</a>
        <a href="#manage" class="pill">å‹•ç•«ç™»è¨˜</a>
        <a href="#dashboard" class="pill">è§€çœ‹ç¸½è¦½</a>
      </nav>
      <button id="themeToggle" class="btn outline" aria-pressed="false" aria-label="åˆ‡æ›æ·±æ·ºè‰²">ä¸»é¡Œ</button>
    </header>

    <main id="app">
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»é ï¼šè¼¸å…¥è§€çœ‹ç´€éŒ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="record" class="container section">
        <h2>âŠ è¼¸å…¥ã€Œå‹•ç•«ç´€éŒ„ã€</h2>
        <div class="card stack">
          <div class="two-col">
            <!-- å‹•ç•«é¸æ“‡ -->
            <div class="stack">
              <label>é¸æ“‡å‹•ç•«</label>
              <div class="select-anime" id="animeSelect">
                <button class="select-btn" id="animeSelectBtn" aria-haspopup="listbox" aria-expanded="false">
                  <div class="left">
                    <img alt="" src="assets/hero.svg">
                    <span class="name">ï¼ˆå°šç„¡ä½œå“ï¼Œè«‹å…ˆåˆ°ã€Œå‹•ç•«ç™»è¨˜ã€æ–°å¢ï¼‰</span>
                  </div>
                  <span class="badge">è§€çœ‹ 0 / 0</span>
                </button>
                <div class="select-list hidden" id="animeSelectList" role="listbox" tabindex="-1" aria-label="é¸æ“‡å‹•ç•«ï¼ˆä¸Šä¸‹éµç§»å‹•ï¼ŒEnter ç¢ºèªï¼‰"></div>
              </div>
              <small class="muted">éµç›¤ <span class="kbd">â†‘</span><span class="kbd">â†“</span> é¸å–ï¼Œ<span class="kbd">Enter</span> ç¢ºèªã€‚</small>
            </div>

            <!-- é›†æ•¸é¸æ“‡ï¼ˆé€±æ¬¡åœ¨ä¸Šæ–¹ + å€é–“è¼¸å…¥ï¼‰ -->
            <div class="stack">
              <!-- é€±æ¬¡é¸æ“‡ï¼ˆæœ€è¿‘ 12 é€±ï¼Œé€±ä¸€â†’é€±æ—¥ï¼‰ -->
              <div class="row">
                <label>é¸æ“‡é€±æ¬¡</label>
                <select id="week-select"></select>
              </div>

              <div class="row" style="justify-content:space-between">
                <label>é¸æ“‡é›†æ•¸</label>
                <span class="muted" id="episodes-hint">å·²çœ‹ 0 / ç¸½ 0</span>
              </div>

              <div class="row range-row">
                <input id="range-start" type="number" min="1" step="1" placeholder="èµ·å§‹">
                <span>â€”</span>
                <input id="range-end" type="number" min="1" step="1" placeholder="çµæŸ">
                <button id="range-submit" class="btn primary">åŠ å…¥</button>
                <span id="range-msg" class="muted" aria-live="polite"></span>
              </div>
            </div>
          </div>

          <div class="row">
            <span id="record-msg" class="muted" aria-live="polite"></span>
          </div>
        </div>
      </section>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¬¬äºŒé ï¼šç™»è¨˜å‹•ç•« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="manage" class="container section">
        <h2>â‹ å‹•ç•«ç™»è¨˜ / ç®¡ç†</h2>
        <div class="row">
          <button id="open-create" class="btn primary">æ–°å¢å‹•ç•«</button>
          <span class="muted">æ–°å¢å¾Œæœƒå‡ºç¾åœ¨ã€Œå‹•ç•«ç´€éŒ„ã€èˆ‡ã€Œè§€çœ‹ç¸½è¦½ã€ã€‚</span>
        </div>

        <div class="section card stack">
          <h3>å·²ç™»è¨˜å‹•ç•«</h3>
          <div id="manage-list" class="manage-grid"></div>
        </div>

        <!-- å»ºç«‹å‹•ç•«å°è©±æ¡†ï¼ˆå–æ¶ˆå¯æ­£å¸¸é—œé–‰ï¼‰ -->
        <dialog id="create-dialog">
          <form class="stack" id="create-form" method="dialog">
            <h3>æ–°å¢å‹•ç•«</h3>
            <label>å‹•ç•«åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰
              <input id="create-image" type="file" accept="image/*">
            </label>
            <label>å‹•ç•«åç¨±
              <input id="create-name" type="text" placeholder="ä¾‹å¦‚ï¼šæ˜Ÿéš›æ¼‚æµè¨˜" required>
            </label>
            <label>å‹•ç•«é›†æ•¸
              <input id="create-episodes" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹å¦‚ï¼š12" required>
            </label>
            <div class="row">
              <button class="btn primary" id="create-submit" type="button">å„²å­˜</button>
              <button class="btn" id="create-cancel" type="button">å–æ¶ˆ</button>
              <span id="create-msg" class="muted" aria-live="polite"></span>
            </div>
          </form>
        </dialog>
      </section>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¬¬ä¸‰é ï¼šç¸½è¦½ / æœå°‹ / åŒ¯å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="dashboard" class="container section">
        <h2>âŒ è§€çœ‹ç¸½è¦½ / æœå°‹ / åŒ¯å‡º</h2>

        <div class="row" style="gap:.5rem; flex-wrap:wrap">
          <button id="export-csv-week" class="btn outline">åŒ¯å‡ºæœ¬é€±ï¼ˆCSVï¼‰</button>
          <button id="export-csv-all" class="btn outline">åŒ¯å‡ºå…¨éƒ¨é€±æ¬¡ï¼ˆå¤šæª” CSVï¼‰</button>
          <span class="muted">E æ¬„çš„ã€Œé€Ÿåº¦è©•åƒ¹ã€ç¨å¾Œä¾ä½ è¦å‰‡æ›´æ–°ã€‚</span>
        </div>

        <div class="section">
          <h3>æœ€æ–°ç™»è¨˜çš„ 9 éƒ¨ä½œå“</h3>
          <div id="latest-grid" class="grid-3"></div>
        </div>

        <div class="section card">
          <h3>æœå°‹å…¶ä»–ä½œå“</h3>
          <div class="row" style="gap:.5rem">
            <input id="search-input" type="search" placeholder="è¼¸å…¥é—œéµå­—..." />
            <button id="search-clear" class="btn">æ¸…é™¤</button>
          </div>
          <div id="search-results" class="grid-3" style="margin-top:1rem"></div>
        </div>
      </section>
    </main>

    <footer class="site-footer container">
      <small>&copy; <span id="year"></span> å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨</small>
    </footer>

    <!-- Starter è…³æœ¬ -->
    <script src="script.js" defer></script>

    <!-- æœ¬é å°ˆç”¨é‚è¼¯ -->
    <script type="module">
      const DB_KEY = 'animeDB_v2'; // å‡ç‰ˆï¼šåŠ å…¥ logs
      /**
       * DB çµæ§‹ï¼š
       * { items: [{id,name,episodes,image,createdAt,updatedAt,watched:number[]}],
       *   logs: [{animeId, weekStartISO, eps:number[], createdAt:number}] }
       */
      function loadDB(){
        let db;
        try { db = JSON.parse(localStorage.getItem(DB_KEY)); } catch {}
        if(!db){
          // å¾ v1 é·ç§»ï¼ˆè‹¥å­˜åœ¨ï¼‰
          try {
            const v1 = JSON.parse(localStorage.getItem('animeDB_v1'));
            if(v1 && v1.items){ db = { items: v1.items, logs: [] }; }
          } catch {}
        }
        return db ?? { items: [], logs: [] };
      }
      function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
      function uid(){ return Math.random().toString(36).slice(2,10); }
      document.getElementById('year').textContent = new Date().getFullYear();

      // â”€â”€ é€±æ¬¡å·¥å…·ï¼ˆå°åŒ—æ™‚å€ï¼Œä»¥æœ¬åœ°æ™‚é–“è¨ˆï¼‰â”€â”€
      function toYMD(d){ return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'); }
      function mondayOf(d){
        const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const day = x.getDay(); // 0 æ—¥ ~ 6 å…­
        const offset = (day+6)%7; // é€±ä¸€=0
        x.setDate(x.getDate()-offset);
        x.setHours(0,0,0,0);
        return x;
      }
      function sundayOf(d){
        const m = mondayOf(d);
        const s = new Date(m);
        s.setDate(m.getDate()+6); s.setHours(23,59,59,999);
        return s;
      }
      function weekLabel(d){
        const m = mondayOf(d);
        const s = sundayOf(d);
        const fmt = (dt)=> String(dt.getMonth()+1).padStart(2,'0')+'/'+String(dt.getDate()).padStart(2,'0');
        return `${fmt(m)}â€“${fmt(s)}`;
      }
      function weekStartISOFromDate(d){ return mondayOf(d).toISOString(); }
      function formatWeekRangeFromISO(iso){
        const d = new Date(iso);
        return weekLabel(d);
      }
      function recentWeeks(n=12){
        const arr = [];
        const now = new Date();
        const thisMon = mondayOf(now);
        for(let i=0;i<n;i++){
          const start = new Date(thisMon);
          start.setDate(thisMon.getDate()-7*i);
          arr.push(start);
        }
        return arr;
      }

      // â”€â”€ DOM åƒç…§ â”€â”€
      const weekSelect      = document.getElementById('week-select');
      const animeSelectBtn  = document.getElementById('animeSelectBtn');
      const animeSelectList = document.getElementById('animeSelectList');
      const episodesHint    = document.getElementById('episodes-hint');
      const rangeStart      = document.getElementById('range-start');
      const rangeEnd        = document.getElementById('range-end');
      const rangeSubmit     = document.getElementById('range-submit');
      const rangeMsg        = document.getElementById('range-msg');
      const recordMsg       = document.getElementById('record-msg');

      const openCreateBtn   = document.getElementById('open-create');
      const createDialog    = document.getElementById('create-dialog');
      const createForm      = document.getElementById('create-form');
      const createImage     = document.getElementById('create-image');
      const createName      = document.getElementById('create-name');
      const createEpsInput  = document.getElementById('create-episodes');
      const createSubmit    = document.getElementById('create-submit');
      const createCancel    = document.getElementById('create-cancel');
      const createMsg       = document.getElementById('create-msg');
      const manageList      = document.getElementById('manage-list');

      const latestGrid      = document.getElementById('latest-grid');
      const searchInput     = document.getElementById('search-input');
      const searchClear     = document.getElementById('search-clear');
      const searchResults   = document.getElementById('search-results');
      const exportWeekBtn   = document.getElementById('export-csv-week');
      const exportAllBtn    = document.getElementById('export-csv-all');

      // ç‹€æ…‹
      let currentAnimeId = null;

      // â”€â”€ å…±ç”¨å°å·¥å…· â”€â”€
      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
      function fileToDataURL(file){
        return new Promise((res,rej)=>{
          const r = new FileReader();
          r.onload = ()=> res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }
      function isComplete(a){ return (a.watched?.length||0) >= a.episodes && a.episodes>0; }
      function badgeHTML(a){
        return `<span class="badge ${isComplete(a)?'complete':''}">è§€çœ‹ ${a.watched?.length||0} / ${a.episodes}</span>`;
      }
      function nextUnwatched(a){
        const watched = new Set(a.watched||[]);
        for(let i=1;i<=a.episodes;i++){ if(!watched.has(i)) return i; }
        return null;
      }

      // â”€â”€ åˆå§‹åŒ–é€±æ¬¡ä¸‹æ‹‰ï¼ˆæœ€è¿‘ 12 é€±ï¼Œé è¨­æœ¬é€±ï¼‰â”€â”€
      function renderWeekSelect(){
        const weeks = recentWeeks(12);
        weekSelect.innerHTML = '';
        weeks.forEach((startDate, idx)=>{
          const opt = new Option(weekLabel(startDate), weekStartISOFromDate(startDate));
          if(idx===0) opt.selected = true; // æœ¬é€±
          weekSelect.add(opt);
        });
      }

      // â”€â”€ ç•«é¢åˆ·æ–° â”€â”€
      function refreshAll(){
        const db = loadDB();
        renderWeekSelectIfEmpty();
        renderAnimeSelect(db);
        renderEpisodesUI(db);
        renderManageList(db);
        renderLatestGrid(db);
        renderSearchResults(db, searchInput.value?.trim() || '');
      }
      function renderWeekSelectIfEmpty(){
        if(weekSelect.options.length === 0) renderWeekSelect();
      }

      // A. è‡ªè¨‚å‹•ç•«ä¸‹æ‹‰
      function renderAnimeSelect(db){
        const items = db.items.slice().sort((a,b)=> b.createdAt - a.createdAt);
        animeSelectList.innerHTML = '';

        if(items.length === 0){
          animeSelectBtn.querySelector('.name').textContent = 'ï¼ˆå°šç„¡ä½œå“ï¼Œè«‹å…ˆåˆ°ã€Œå‹•ç•«ç™»è¨˜ã€æ–°å¢ï¼‰';
          animeSelectBtn.querySelector('img').src = 'assets/hero.svg';
          animeSelectBtn.querySelector('.badge').textContent = 'è§€çœ‹ 0 / 0';
          currentAnimeId = null;
          return;
        }
        if(!items.some(x=> x.id === currentAnimeId)){
          currentAnimeId = items[0].id;
        }
        for(const a of items){
          const row = document.createElement('div');
          row.className = 'select-item';
          row.setAttribute('role','option');
          row.dataset.id = a.id;
          row.innerHTML = `
            <div class="left">
              <img alt="" src="${a.image || 'assets/hero.svg'}">
              <div class="ellipsis-1">${a.name}</div>
            </div>
            ${badgeHTML(a)}
          `;
          row.addEventListener('click', ()=>{
            currentAnimeId = a.id;
            closeAnimeList();
            updateAnimeButton(a);
            renderEpisodesUI(loadDB());
          });
          animeSelectList.appendChild(row);
        }
        const cur = db.items.find(x=> x.id === currentAnimeId);
        if(cur) updateAnimeButton(cur);
      }
      function updateAnimeButton(a){
        animeSelectBtn.querySelector('img').src = a.image || 'assets/hero.svg';
        animeSelectBtn.querySelector('.name').textContent = a.name;
        const b = animeSelectBtn.querySelector('.badge');
        b.innerHTML = `è§€çœ‹ ${a.watched?.length||0} / ${a.episodes}`;
        b.classList.toggle('complete', isComplete(a));
        animeSelectBtn.setAttribute('aria-expanded','false');
      }
      function openAnimeList(){
        animeSelectList.classList.remove('hidden');
        animeSelectBtn.setAttribute('aria-expanded','true');
        animeSelectList.focus();
      }
      function closeAnimeList(){
        animeSelectList.classList.add('hidden');
        animeSelectBtn.setAttribute('aria-expanded','false');
      }
      animeSelectBtn.addEventListener('click', ()=>{
        const open = animeSelectBtn.getAttribute('aria-expanded') === 'true';
        open ? closeAnimeList() : openAnimeList();
      });
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#animeSelect')) closeAnimeList();
      });

      // B. é›†æ•¸å€åŸŸï¼ˆåƒ…å€é–“ï¼›ä¾é€±è¨˜éŒ„ï¼‰
      function renderEpisodesUI(db){
        const a = db.items.find(x=> x.id === currentAnimeId);
        rangeMsg.textContent = '';
        recordMsg.textContent = '';

        if(!a){
          episodesHint.textContent = 'å·²çœ‹ 0 / ç¸½ 0';
          rangeStart.value = ''; rangeEnd.value = '';
          return;
        }
        episodesHint.textContent = `å·²çœ‹ ${a.watched?.length||0} / ç¸½ ${a.episodes}`;

        const next = nextUnwatched(a) ?? 1;
        rangeStart.min = '1'; rangeStart.max = String(a.episodes);
        rangeEnd.min   = '1'; rangeEnd.max   = String(a.episodes);
        rangeStart.value = String(next);
        rangeEnd.value   = String(next);
      }

      rangeSubmit.addEventListener('click', ()=>{
        const db = loadDB();
        const a = db.items.find(x=> x.id === currentAnimeId);
        if(!a){ rangeMsg.textContent = 'è«‹å…ˆé¸æ“‡å‹•ç•«ã€‚'; return; }

        const weekStartISO = weekSelect.value; // ä»¥é¸å–é€±æ¬¡å­˜æª”
        let s = parseInt(rangeStart.value,10);
        let e = parseInt(rangeEnd.value,10);
        if(!Number.isFinite(s) || !Number.isFinite(e)){ rangeMsg.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·è¨–é›†æ•¸ã€‚'; return; }

        s = clamp(s, 1, a.episodes);
        e = clamp(e, 1, a.episodes);
        if(s > e){ [s,e] = [e,s]; }

        const watched = new Set(a.watched||[]);
        const all = [], conflicts = [];
        for(let i=s;i<=e;i++){ (watched.has(i) ? conflicts : all).push(i); }
        if(conflicts.length){
          rangeMsg.textContent = `å·²æœ‰ç´€éŒ„ï¼š${conflicts.map(n=>'Ep'+n).join(', ')}ã€‚è«‹èª¿æ•´å€é–“å¾Œå†è©¦ã€‚`;
          return;
        }
        if(all.length===0){ rangeMsg.textContent = 'æ­¤å€é–“æ²’æœ‰å¯æ–°å¢çš„é›†æ•¸ã€‚'; return; }

        // æ›´æ–°å…¨åŸŸ watched
        a.watched = Array.from(new Set([...(a.watched||[]), ...all])).sort((x,y)=>x-y);
        a.updatedAt = Date.now();

        // é€±èªŒï¼šè‹¥åŒä¸€é€±åŒä¸€ä½œå“å·²å­˜åœ¨ï¼Œå°±åˆä½µ epï¼ˆå»é‡ï¼‰
        const key = { animeId:a.id, weekStartISO };
        const exist = db.logs.find(l => l.animeId===key.animeId && l.weekStartISO===key.weekStartISO);
        if(exist){
          exist.eps = Array.from(new Set([...(exist.eps||[]), ...all])).sort((x,y)=>x-y);
          exist.createdAt = Date.now();
        }else{
          db.logs.push({ animeId:a.id, weekStartISO, eps: all.slice().sort((x,y)=>x-y), createdAt: Date.now() });
        }

        saveDB(db);
        rangeMsg.textContent = `å·²åŠ å…¥ï¼š${all.map(n=>'Ep'+n).join(', ')}ï¼ˆé€±æ¬¡ï¼š${formatWeekRangeFromISO(weekStartISO)}ï¼‰`;
        renderEpisodesUI(db);
        renderLatestGrid(db);
        renderAnimeSelect(db);
      });

      weekSelect.addEventListener('change', ()=> {
        // åˆ‡é€±æ¬¡ä¸å½±éŸ¿ watchedï¼Œåªå½±éŸ¿æç¤ºèˆ‡åŒ¯å‡º/å¯«å…¥ä½ç½®
        rangeMsg.textContent = '';
      });

      // C. ç™»è¨˜é 
      function renderManageList(db){
        manageList.innerHTML = '';
        if(db.items.length === 0){
          manageList.innerHTML = '<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>';
          return;
        }
        const items = db.items.slice().sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'));
        for(const a of items){
          const card = document.createElement('article');
          card.className = 'manage-card';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="right">
              <div class="title-row">
                <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
                ${badgeHTML(a)}
              </div>
              <small class="muted">å…± ${a.episodes} é›† Â· å·²çœ‹ ${a.watched?.length||0} é›†</small>
            </div>
            <button class="icon-btn" title="åˆªé™¤" aria-label="åˆªé™¤">
              <svg class="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          `;
          card.querySelector('.icon-btn').addEventListener('click', ()=>{
            if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${a.name}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)){
              const idx = db.items.findIndex(x=>x.id===a.id);
              if(idx>-1){
                db.items.splice(idx,1);
                // åŒæ­¥ç§»é™¤è©²ä½œå“çš„é€±èªŒ
                db.logs = db.logs.filter(l => l.animeId !== a.id);
                saveDB(db);
                refreshAll();
              }
            }
          });
          manageList.appendChild(card);
        }
      }

      // æ–°å¢å‹•ç•«ï¼ˆå–æ¶ˆä¸€å®šé—œï¼‰
      openCreateBtn.addEventListener('click', ()=> {
        createForm.reset();
        createMsg.textContent = '';
        createDialog.showModal();
      });
      createCancel.addEventListener('click', ()=> {
        createDialog.close();
      });
      createDialog.addEventListener('cancel', (e)=>{ /* Esc é—œé–‰ */ e.preventDefault(); createDialog.close(); });

      createSubmit.addEventListener('click', async ()=>{
        createMsg.textContent = '';
        const name = createName.value.trim();
        const eps  = createEpsInput.value.trim();
        if(!name){ createMsg.textContent = 'è«‹è¼¸å…¥åç¨±'; return; }
        if(!/^[0-9]+$/.test(eps)){ createMsg.textContent = 'é›†æ•¸åƒ…èƒ½è¼¸å…¥æ•¸å­—'; return; }
        const episodes = Math.max(1, parseInt(eps,10));

        const db = loadDB();
        if(db.items.some(x=> x.name === name)){ createMsg.textContent = 'æ­¤åç¨±å·²å­˜åœ¨ï¼Œè‹¥è¦é‡æ–°ä¸Šå‚³è«‹å…ˆåˆªé™¤èˆŠè³‡æ–™ã€‚'; return; }

        let imageData = null;
        const file = createImage.files?.[0];
        if(file){ imageData = await fileToDataURL(file); }

        const id = uid();
        db.items.push({ id, name, episodes, image: imageData || undefined, createdAt: Date.now(), updatedAt: Date.now(), watched: [] });
        saveDB(db);
        currentAnimeId = id;
        createDialog.close();
        refreshAll();
      });

      // D. ç¸½è¦½ï¼ˆæœ€æ–° 9 éƒ¨ï¼‰
      function renderLatestGrid(db){
        latestGrid.innerHTML = '';
        if(db.items.length === 0){
          latestGrid.innerHTML = '<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>';
          return;
        }
        const top9 = db.items.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0,9);
        for(const a of top9){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
              ${badgeHTML(a)}
            </div>
          `;
          latestGrid.appendChild(card);
        }
      }
      function renderSearchResults(db, keyword){
        searchResults.innerHTML = '';
        const list = db.items.slice();
        const kw = (keyword||'').trim();
        const results = !kw ? [] : list.filter(a => a.name.toLowerCase().includes(kw.toLowerCase()));
        if(!kw){ return; }
        if(results.length === 0){
          searchResults.innerHTML = '<div class="muted">æ²’æœ‰ç¬¦åˆçš„ä½œå“ã€‚</div>';
          return;
        }
        for(const a of results){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
              ${badgeHTML(a)}
            </div>
          `;
          searchResults.appendChild(card);
        }
      }
      searchInput.addEventListener('input', ()=> renderSearchResults(loadDB(), searchInput.value));
      searchClear.addEventListener('click', ()=>{ searchInput.value = ''; renderSearchResults(loadDB(), ''); });

      // E. åŒ¯å‡ºï¼ˆå–®é€± / å…¨éƒ¨é€±æ¬¡ï¼‰
      function csvEscape(v){ const s = String(v ?? ''); return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; }
      function compressToRanges(nums){
        // è¼¸å…¥æ’åºå¾Œçš„æ•¸åˆ—ï¼Œè¼¸å‡º ["5~7","9","12~13"] é€™ç¨®ç‰‡æ®µ
        if(nums.length===0) return [];
        const a = nums.slice().sort((x,y)=>x-y);
        const out = [];
        let start = a[0], prev = a[0];
        for(let i=1;i<a.length;i++){
          const cur = a[i];
          if(cur === prev + 1){ prev = cur; continue; }
          out.push(start===prev ? String(start) : `${start}~${prev}`);
          start = prev = cur;
        }
        out.push(start===prev ? String(start) : `${start}~${prev}`);
        return out;
      }
      function exportWeekCSV(weekStartISO){
        const db = loadDB();
        const rows = [['å‹•æ¼«','é›†æ•¸','é€²åº¦(ç¬¬Xé›†)','', 'é€Ÿåº¦è©•åƒ¹(Yé›†)']];
        const logs = db.logs.filter(l => l.weekStartISO === weekStartISO);
        // ä»¥ä½œå“èšåˆ
        const byAnime = new Map();
        for(const l of logs){
          const eps = byAnime.get(l.animeId) || new Set();
          (l.eps||[]).forEach(x=> eps.add(x));
          byAnime.set(l.animeId, eps);
        }
        let sum = 0;
        for(const [animeId, epsSet] of byAnime.entries()){
          const a = db.items.find(x=> x.id===animeId);
          const eps = Array.from(epsSet).sort((x,y)=>x-y);
          const ranges = compressToRanges(eps);
          const count = eps.length;
          rows.push([ a?.name ?? animeId, String(count), ranges.join(','), '', `ï¼ˆ${count}é›†ï¼‰` ]);
          sum += count;
        }
        rows.push(['ç¸½è¨ˆ', String(sum)]);
        const csv = rows.map(r=> r.map(csvEscape).join(',')).join('\r\n');
        const filename = `anime_watch_${formatWeekRangeFromISO(weekStartISO).replace(/[^\d~â€“]/g,'').replace('â€“','-')}.csv`;
        downloadText(csv, filename);
      }
      function exportAllWeeksCSV(){
        const db = loadDB();
        const weeks = Array.from(new Set(db.logs.map(l=> l.weekStartISO))).sort(); // èˆŠâ†’æ–°
        for(const w of weeks){ exportWeekCSV(w); }
      }
      function downloadText(text, filename){
        const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }

      exportWeekBtn.addEventListener('click', ()=> {
        const weekStartISO = weekSelect.value || weekStartISOFromDate(new Date());
        exportWeekCSV(weekStartISO);
      });
      exportAllBtn.addEventListener('click', ()=> exportAllWeeksCSV());

      // â”€â”€ é¦–æ¬¡è¼‰å…¥ â”€â”€
      refreshAll();
    </script>
  </body>
</html>
