<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å‹•ç•«è§€è³ç´€éŒ„</title>
    <meta name="description" content="ç™»è¨˜å‹•ç•«ã€å‹¾é¸è§€çœ‹é›†æ•¸ã€å¯è¦–åŒ–ç¸½è¦½èˆ‡åŒ¯å‡ºã€‚" />
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <meta property="og:title" content="å‹•ç•«è§€è³ç´€éŒ„" />
    <meta property="og:description" content="ç™»è¨˜å‹•ç•«ã€å‹¾é¸è§€çœ‹é›†æ•¸ã€å¯è¦–åŒ–ç¸½è¦½èˆ‡åŒ¯å‡ºã€‚" />
    <meta property="og:type" content="website" />
    <style>
      /* å°‘é‡å¢è£œæ¨£å¼ï¼Œæ²¿ç”¨åŸæœ¬çš„è¨­è¨ˆèªå½™ */
      .tabs { display:flex; gap:.5rem; flex-wrap:wrap; }
      .tabs a { text-decoration:none; }
      .hidden{ display:none !important }
      .stack{ display:grid; gap:1rem }
      .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap }
      .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
      .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem }
      .pill{ border:1px solid var(--border); padding:.25rem .6rem; border-radius:999px; font-size:.9rem; color:var(--muted)}
      .muted{ color:var(--muted) }
      .thumb{ width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:.75rem; border:1px solid var(--border); background:#0002 }
      .badge{ font-size:.8rem; padding:.2rem .5rem; border-radius:.5rem; border:1px solid var(--border); }
      dialog{ border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:1rem; padding:1rem; max-width:560px }
      dialog::backdrop{ background: rgba(0,0,0,.4) }
      .checkboxes{ display:grid; grid-template-columns:repeat(6,1fr); gap:.5rem }
      @media (max-width: 860px){
        .two-col{ grid-template-columns:1fr }
        .grid-3{ grid-template-columns:1fr }
        .checkboxes{ grid-template-columns:repeat(4,1fr) }
      }
      select[multiple]{ min-height:6rem }
      .search-row{ display:flex; gap:.5rem; align-items:center; margin-top:.5rem }
    </style>
  </head>
  <body>
    <header class="site-header container">
      <a class="brand" href="#record" aria-label="é¦–é ">ğŸï¸ è§€è³ç´€éŒ„</a>
      <nav class="nav tabs" aria-label="ä¸»é¸å–®">
        <a href="#record" class="pill">ç´€éŒ„</a>
        <a href="#manage" class="pill">ç™»è¨˜</a>
        <a href="#dashboard" class="pill">ç¸½è¦½</a>
      </nav>
      <button id="themeToggle" class="btn outline" aria-pressed="false" aria-label="åˆ‡æ›æ·±æ·ºè‰²">ä¸»é¡Œ</button>
    </header>

    <main id="app">
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»é ï¼šè¼¸å…¥è§€çœ‹ç´€éŒ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="record" class="container section">
        <h2>âŠ è¼¸å…¥è§€çœ‹ç´€éŒ„</h2>
        <div class="card stack">
          <div class="two-col">
            <label>é¸æ“‡å‹•ç•«
              <select id="record-anime" required></select>
            </label>

            <div>
              <div class="row" style="justify-content:space-between">
                <label>é¸æ“‡é›†æ•¸ï¼ˆè‡ªå‹•éš±è—å·²çœ‹éï¼‰</label>
                <span class="muted" id="episodes-hint"></span>
              </div>
              <div id="episode-checkboxes" class="checkboxes"></div>
            </div>
          </div>
          <div class="row">
            <button id="record-submit" class="btn primary">åŠ å…¥è§€çœ‹ç´€éŒ„</button>
            <span id="record-msg" class="muted" aria-live="polite"></span>
          </div>
        </div>
      </section>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¬¬äºŒé ï¼šç™»è¨˜å‹•ç•« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="manage" class="container section">
        <h2>â‹ ç™»è¨˜ / ç®¡ç†å‹•ç•«</h2>
        <div class="row">
          <button id="open-create" class="btn primary">æ–°å¢å‹•ç•«</button>
          <span class="muted">æ–°å¢å¾Œæœƒå‡ºç¾åœ¨ã€Œç´€éŒ„ã€çš„ä¸‹æ‹‰é¸å–®èˆ‡ã€Œç¸½è¦½ã€ã€‚</span>
        </div>

        <div class="section card stack">
          <h3>å·²ç™»è¨˜å‹•ç•«</h3>
          <div id="manage-list" class="grid"></div>
        </div>

        <!-- å»ºç«‹å‹•ç•«å°è©±æ¡† -->
        <dialog id="create-dialog">
          <form method="dialog" class="stack" id="create-form">
            <h3>æ–°å¢å‹•ç•«</h3>
            <label>å‹•ç•«åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰
              <input id="create-image" type="file" accept="image/*">
            </label>
            <label>å‹•ç•«åç¨±
              <input id="create-name" type="text" placeholder="ä¾‹å¦‚ï¼šæ˜Ÿéš›æ¼‚æµè¨˜" required>
            </label>
            <label>å‹•ç•«é›†æ•¸ï¼ˆåªå…è¨± 0-9 æ•¸å­—ï¼‰
              <input id="create-episodes" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹å¦‚ï¼š12" required>
            </label>
            <div class="row">
              <button class="btn primary" id="create-submit">å„²å­˜</button>
              <button class="btn" value="cancel">å–æ¶ˆ</button>
              <span id="create-msg" class="muted" aria-live="polite"></span>
            </div>
          </form>
        </dialog>
      </section>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¬¬ä¸‰é ï¼šç¸½è¦½ / æœå°‹ / åŒ¯å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="dashboard" class="container section">
        <h2>âŒ ç¸½è¦½ / æœå°‹ / åŒ¯å‡º</h2>

        <div class="row">
          <button id="export-csv" class="btn outline">åŒ¯å‡ºè©¦ç®—è¡¨ï¼ˆCSVï¼‰</button>
          <span class="muted">ç›®å‰å…ˆè¼¸å‡º CSVï¼›æ ¼å¼ä¹‹å¾Œå¯å†èª¿æ•´ã€‚</span>
        </div>

        <div class="section">
          <h3>æœ€æ–°ç™»è¨˜çš„ 9 éƒ¨ä½œå“</h3>
          <div id="latest-grid" class="grid-3"></div>
        </div>

        <div class="section card">
          <h3>æœå°‹å…¶ä»–ä½œå“</h3>
          <div class="search-row">
            <input id="search-input" type="search" placeholder="è¼¸å…¥é—œéµå­—..." />
            <button id="search-clear" class="btn">æ¸…é™¤</button>
          </div>
          <div id="search-results" class="grid-3" style="margin-top:1rem"></div>
        </div>
      </section>
    </main>

    <footer class="site-footer container">
      <small>&copy; <span id="year"></span> ä½ çš„å‹•ç•«è§€è³è¨˜éŒ„å™¨</small>
    </footer>

    <!-- åŸæœ¬ starter çš„è…³æœ¬ï¼ˆä¸»é¡Œåˆ‡æ›/å¹´ä»½ï¼‰ -->
    <script src="script.js" defer></script>

    <!-- æœ¬é å°ˆç”¨é‚è¼¯ -->
    <script type="module">
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è³‡æ–™æ¨¡å‹èˆ‡å„²å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const DB_KEY = 'animeDB_v1';
      /** @type {{items: Array<{id:string,name:string,episodes:number,image?:string,createdAt:number,updatedAt:number,watched:number[]}>}} */
      function loadDB(){
        try { return JSON.parse(localStorage.getItem(DB_KEY)) ?? { items: [] }; }
        catch { return { items: [] }; }
      }
      function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

      function uid(){ return Math.random().toString(36).slice(2,10); }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é é¢è·¯ç”±ï¼ˆhashï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sections = ['record','manage','dashboard'];
      function show(hash){
        const id = hash?.replace('#','') || 'record';
        sections.forEach(s => document.getElementById(s).classList.toggle('hidden', s !== id));
        history.replaceState(null,'', '#'+id);
      }
      window.addEventListener('hashchange', ()=> show(location.hash));
      show(location.hash);

      // å¹´ä»½
      document.getElementById('year').textContent = new Date().getFullYear();

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…ƒä»¶åƒç…§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const recordAnime = document.getElementById('record-anime');
      const episodeBoxes = document.getElementById('episode-checkboxes');
      const episodesHint = document.getElementById('episodes-hint');
      const recordSubmit = document.getElementById('record-submit');
      const recordMsg = document.getElementById('record-msg');

      const openCreateBtn = document.getElementById('open-create');
      const createDialog = document.getElementById('create-dialog');
      const createForm = document.getElementById('create-form');
      const createImage = document.getElementById('create-image');
      const createName = document.getElementById('create-name');
      const createEps  = document.getElementById('create-episodes');
      const createMsg  = document.getElementById('create-msg');
      const manageList = document.getElementById('manage-list');

      const latestGrid = document.getElementById('latest-grid');
      const searchInput = document.getElementById('search-input');
      const searchClear = document.getElementById('search-clear');
      const searchResults = document.getElementById('search-results');
      const exportBtn = document.getElementById('export-csv');

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI åˆå§‹åŒ–/åˆ·æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function refreshAll(){
        const db = loadDB();
        renderRecordAnimeOptions(db);
        renderEpisodeBoxes(db);
        renderManageList(db);
        renderLatestGrid(db);
        renderSearchResults(db, searchInput.value.trim());
      }

      function renderRecordAnimeOptions(db){
        recordAnime.innerHTML = '';
        if(db.items.length === 0){
          const opt = new Option('ï¼ˆå°šç„¡ä½œå“ï¼Œè«‹å…ˆåˆ°ã€Œç™»è¨˜ã€æ–°å¢ï¼‰','');
          recordAnime.add(opt);
          return;
        }
        db.items
          .slice()
          .sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'))
          .forEach(item => recordAnime.add(new Option(item.name, item.id)));
      }

      function getSelectedAnime(db){
        const id = recordAnime.value;
        return db.items.find(x => x.id === id) || null;
      }

      function renderEpisodeBoxes(db){
        const a = getSelectedAnime(db);
        episodeBoxes.innerHTML = '';
        if(!a){
          episodesHint.textContent = '';
          return;
        }
        const watched = new Set(a.watched || []);
        const available = [];
        for(let i=1;i<=a.episodes;i++){
          if(!watched.has(i)) available.push(i);
        }
        episodesHint.textContent = `å¯å‹¾é¸ï¼š${available.length} é›†ï¼ˆå…± ${a.episodes} é›†ï¼‰`;
        if(available.length === 0){
          episodeBoxes.innerHTML = '<span class="muted">æœ¬ä½œå“å·²å…¨éƒ¨çœ‹å®Œ ğŸ‰</span>';
          return;
        }
        const frag = document.createDocumentFragment();
        for(const ep of available){
          const id = 'ep_' + ep;
          const label = document.createElement('label');
          label.className = 'row';
          label.innerHTML = `
            <input type="checkbox" id="${id}" value="${ep}">
            <span>Ep${ep}</span>
          `;
          frag.appendChild(label);
        }
        episodeBoxes.appendChild(frag);
      }

      function renderManageList(db){
        manageList.innerHTML = '';
        if(db.items.length === 0){
          manageList.innerHTML = '<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>';
          return;
        }
        const grid = document.createElement('div');
        grid.className = 'grid-3';
        db.items
          .slice()
          .sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'))
          .forEach(a=>{
            const card = document.createElement('article');
            card.className = 'card stack';
            const img = document.createElement('img');
            img.className = 'thumb';
            img.alt = a.name;
            img.src = a.image || 'assets/hero.svg';
            const title = document.createElement('div');
            title.className = 'row';
            title.style.justifyContent = 'space-between';
            title.innerHTML = `<strong>${a.name}</strong><span class="badge">å…± ${a.episodes} é›†</span>`;
            const meta = document.createElement('small');
            meta.className = 'muted';
            meta.textContent = 'å·²çœ‹ ' + (a.watched?.length||0) + ' é›†';

            const del = document.createElement('button');
            del.className = 'btn';
            del.textContent = 'åˆªé™¤';
            del.addEventListener('click', ()=>{
              if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${a.name}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)){
                const idx = db.items.findIndex(x=>x.id===a.id);
                if(idx>-1){ db.items.splice(idx,1); saveDB(db); refreshAll(); }
              }
            });

            card.append(img,title,meta,del);
            grid.appendChild(card);
          });
        manageList.appendChild(grid);
      }

      function renderLatestGrid(db){
        latestGrid.innerHTML = '';
        if(db.items.length === 0){
          latestGrid.innerHTML = '<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>';
          return;
        }
        const top9 = db.items
          .slice()
          .sort((a,b)=> b.createdAt - a.createdAt)
          .slice(0,9);
        for(const a of top9){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong>${a.name}</strong>
              <span class="badge">è§€çœ‹ ${a.watched?.length||0} / ${a.episodes}</span>
            </div>
          `;
          const select = document.createElement('select');
          select.multiple = true;
          select.title = 'å·²è§€çœ‹é›†æ•¸';
          const watched = (a.watched||[]).slice().sort((x,y)=>x-y);
          if(watched.length===0){
            select.size = 2;
            select.innerHTML = `<option disabled>å°šæœªæœ‰ç´€éŒ„</option>`;
          }else{
            select.size = Math.min(8, Math.max(2, watched.length));
            for(const ep of watched){
              const opt = new Option('Ep'+ep, String(ep));
              select.add(opt);
            }
          }
          card.appendChild(select);
          latestGrid.appendChild(card);
        }
      }

      function renderSearchResults(db, keyword){
        searchResults.innerHTML = '';
        const list = db.items.slice();
        const results = !keyword ? [] : list.filter(a =>
          a.name.toLowerCase().includes(keyword.toLowerCase())
        );
        if(!keyword){ return; }
        if(results.length === 0){
          searchResults.innerHTML = '<div class="muted">æ²’æœ‰ç¬¦åˆçš„ä½œå“ã€‚</div>';
          return;
        }
        for(const a of results){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong>${a.name}</strong>
              <span class="badge">è§€çœ‹ ${a.watched?.length||0} / ${a.episodes}</span>
            </div>
          `;
          const select = document.createElement('select');
          select.multiple = true;
          const watched = (a.watched||[]).slice().sort((x,y)=>x-y);
          if(watched.length===0){
            select.size = 2;
            select.innerHTML = `<option disabled>å°šæœªæœ‰ç´€éŒ„</option>`;
          }else{
            select.size = Math.min(8, Math.max(2, watched.length));
            for(const ep of watched){
              select.add(new Option('Ep'+ep, String(ep)));
            }
          }
          card.appendChild(select);
          searchResults.appendChild(card);
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç´€éŒ„é ï¼šäº’å‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      recordAnime.addEventListener('change', ()=> renderEpisodeBoxes(loadDB()));

      recordSubmit.addEventListener('click', ()=>{
        const db = loadDB();
        const a = getSelectedAnime(db);
        if(!a){ recordMsg.textContent = 'è«‹å…ˆé¸æ“‡å‹•ç•«ã€‚'; return; }
        const selected = Array.from(episodeBoxes.querySelectorAll('input[type="checkbox"]:checked'))
          .map(x=> Number(x.value));
        if(selected.length === 0){
          recordMsg.textContent = 'è«‹å‹¾é¸è‡³å°‘ä¸€é›†ã€‚';
          return;
        }
        a.watched = Array.from(new Set([...(a.watched||[]), ...selected])).sort((x,y)=>x-y);
        a.updatedAt = Date.now();
        saveDB(db);
        recordMsg.textContent = `å·²åŠ å…¥ï¼š${selected.map(n=>'Ep'+n).join(', ')}`;
        renderEpisodeBoxes(db);
        renderLatestGrid(db);
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç™»è¨˜é ï¼šæ–°å¢/åˆªé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      openCreateBtn.addEventListener('click', ()=> {
        createForm.reset();
        createMsg.textContent = '';
        createDialog.showModal();
      });

      createForm.addEventListener('submit', (e)=>{
        e.preventDefault();
      });

      document.getElementById('create-submit').addEventListener('click', async (e)=>{
        e.preventDefault();
        createMsg.textContent = '';
        const name = createName.value.trim();
        const eps  = createEps.value.trim();

        if(!name){ createMsg.textContent = 'è«‹è¼¸å…¥åç¨±'; return; }
        if(!/^[0-9]+$/.test(eps)){ createMsg.textContent = 'é›†æ•¸åƒ…èƒ½è¼¸å…¥æ•¸å­—'; return; }
        const episodes = Math.max(0, parseInt(eps,10));
        const db = loadDB();

        // é¿å…é‡è¤‡åç¨±ï¼ˆåŒåè¦–ç‚ºåŒä½œå“ï¼‰
        if(db.items.some(x=> x.name === name)){
          createMsg.textContent = 'æ­¤åç¨±å·²å­˜åœ¨ï¼Œè‹¥è¦é‡æ–°ä¸Šå‚³è«‹å…ˆåˆªé™¤èˆŠè³‡æ–™ã€‚';
          return;
        }

        let imageData = null;
        const file = createImage.files?.[0];
        if(file){
          imageData = await fileToDataURL(file);
        }

        db.items.push({
          id: uid(),
          name,
          episodes,
          image: imageData || undefined,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          watched: []
        });
        saveDB(db);
        createMsg.textContent = 'å·²æ–°å¢ï¼';
        createDialog.close();
        refreshAll();
      });

      function fileToDataURL(file){
        return new Promise((res,rej)=>{
          const r = new FileReader();
          r.onload = ()=> res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¸½è¦½ï¼šæœå°‹ / åŒ¯å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      searchInput.addEventListener('input', ()=> renderSearchResults(loadDB(), searchInput.value.trim()));
      searchClear.addEventListener('click', ()=>{
        searchInput.value = '';
        renderSearchResults(loadDB(), '');
      });

      exportBtn.addEventListener('click', ()=>{
        const db = loadDB();
        const rows = [
          ['name','episodes_total','watched_count','watched_list','created_at','updated_at']
        ];
        for(const a of db.items){
          rows.push([
            a.name,
            String(a.episodes),
            String(a.watched?.length||0),
            (a.watched||[]).sort((x,y)=>x-y).map(n=>'Ep'+n).join(' '),
            new Date(a.createdAt).toISOString(),
            new Date(a.updatedAt).toISOString()
          ]);
        }
        const csv = rows.map(r => r.map(v => csvEscape(v)).join(',')).join('\r\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'anime_watch_export.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      function csvEscape(v){
        const s = String(v ?? '');
        if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
        return s;
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é¦–æ¬¡è¼‰å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // è‹¥æ²’æœ‰ä»»ä½•ä½œå“ï¼Œç´€éŒ„é çš„ä¸‹æ‹‰æœƒæç¤ºå»ç™»è¨˜
      refreshAll();
    </script>
  </body>
</html>
