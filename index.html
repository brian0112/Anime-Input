<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å‹•ç•«é€²åº¦</title>
    <meta name="description" content="ç™»è¨˜å‹•ç•«ã€è¼¸å…¥è§€çœ‹ç´€éŒ„ã€ç¸½è¦½èˆ‡åŒ¯å‡ºã€‚"/>
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <meta property="og:title" content="å‹•ç•«é€²åº¦" />
    <meta property="og:description" content="ç™»è¨˜å‹•ç•«ã€è¼¸å…¥è§€çœ‹ç´€éŒ„ã€ç¸½è¦½èˆ‡åŒ¯å‡ºã€‚"/>
    <meta property="og:type" content="website" />
    <style>
      .tabs { display:flex; gap:.5rem; flex-wrap:wrap; }
      .tabs a { text-decoration:none; }
      .hidden{ display:none !important }
      .stack{ display:grid; gap:1rem }
      .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap }
      .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
      .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem }
      .pill{ border:1px solid var(--border); padding:.25rem .6rem; border-radius:999px; font-size:.9rem; color:var(--muted)}
      .muted{ color:var(--muted) }
      .thumb{ width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:.75rem; border:1px solid var(--border); background:#0002 }
      .badge{ font-size:.8rem; padding:.2rem .5rem; border-radius:.5rem; border:1px solid var(--border); }
      .badge.complete{ background:var(--brand); color:var(--brand-ink); border-color:transparent; font-weight:700; }
      dialog{ border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:1rem; padding:1rem; max-width:560px }
      dialog::backdrop{ background: rgba(0,0,0,.4) }

      /* è‡ªè¨‚å‹•ç•«ä¸‹æ‹‰ï¼ˆå¸¶ç¸®åœ–ï¼‰ */
      .select-anime { position:relative; }
      .select-btn { width:100%; display:flex; align-items:center; justify-content:space-between; gap:.75rem; border:1px solid var(--border); background:transparent; color:var(--text); padding:.6rem .9rem; border-radius:.8rem; cursor:pointer; }
      .select-btn .left { display:flex; align-items:center; gap:.75rem; min-width:0; }
      .select-btn img { width:36px; height:36px; border-radius:.5rem; object-fit:cover; border:1px solid var(--border); }
      .select-btn .name { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .select-list { position:absolute; z-index:20; inset: auto 0 0 0; transform: translateY(100%); background:var(--panel); border:1px solid var(--border); border-radius:.8rem; padding:.4rem; max-height:300px; overflow:auto; box-shadow: 0 10px 30px #0005; }
      .select-item { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem .6rem; border-radius:.6rem; cursor:pointer; }
      .select-item:hover{ background:#ffffff10 }
      .select-item .left{ display:flex; align-items:center; gap:.6rem; }
      .select-item img { width:40px; height:40px; border-radius:.5rem; object-fit:cover; border:1px solid var(--border); }
      .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.8rem; padding:.1rem .35rem; border:1px solid var(--border); border-radius:.35rem; color:var(--muted) }

      /* é›†æ•¸ chips èˆ‡æ§åˆ¶åˆ— */
      .chips{ display:flex; flex-wrap:wrap; gap:.4rem; }
      .chip{ border:1px solid var(--border); border-radius:999px; padding:.25rem .6rem; cursor:pointer; user-select:none; }
      .chip.selected{ background:var(--brand); color:var(--brand-ink); border-color:transparent; font-weight:700; }
      details > summary { cursor:pointer; list-style: none; }
      details > summary::-webkit-details-marker{ display:none; }
      .range-row input[type="number"]{ width:6rem; }

      /* ç®¡ç†é å¡ç‰‡ï¼šå…©æ¬„ã€å·¦åœ–å³æ–‡ */
      .manage-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:1rem }
      .manage-card{ display:grid; grid-template-columns: 1.3fr 1fr; gap:1rem; border:1px solid var(--border); background:var(--panel); border-radius:1rem; padding:1rem; position:relative; }
      .manage-card .thumb{ aspect-ratio:16/9; width:100%; }
      .manage-card .title-row{ display:flex; justify-content:space-between; gap:.75rem; align-items:flex-start }
      .icon-btn{ position:absolute; top:.6rem; right:.6rem; border:1px solid var(--border); background:transparent; border-radius:.6rem; padding:.4rem; cursor:pointer; }
      .icon-btn:hover{ background:#ffffff10 }
      .icon-trash{ width:18px; height:18px; display:block }
      .ellipsis-1{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }

      @media (max-width: 1024px){
        .two-col{ grid-template-columns:1fr }
        .grid-3{ grid-template-columns:1fr }
        .manage-grid{ grid-template-columns:1fr }
      }
    </style>
  </head>
  <body>
    <header class="site-header container">
      <a class="brand" href="#record" aria-label="é¦–é ">ğŸï¸ å‹•ç•«é€²åº¦</a>
      <nav class="nav tabs" aria-label="ä¸»é¸å–®">
        <a href="#record" class="pill">å‹•ç•«ç´€éŒ„</a>
        <a href="#manage" class="pill">å‹•ç•«ç™»è¨˜</a>
        <a href="#dashboard" class="pill">è§€çœ‹ç¸½è¦½</a>
      </nav>
      <button id="themeToggle" class="btn outline" aria-pressed="false" aria-label="åˆ‡æ›æ·±æ·ºè‰²">ä¸»é¡Œ</button>
    </header>

    <main id="app">
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»é ï¼šè¼¸å…¥è§€çœ‹ç´€éŒ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="record" class="container section">
        <h2>âŠ è¼¸å…¥ã€Œå‹•ç•«ç´€éŒ„ã€</h2>
        <div class="card stack">
          <div class="two-col">
            <!-- è‡ªè¨‚å‹•ç•«ä¸‹æ‹‰ï¼ˆå«ç¸®åœ–èˆ‡å¾½ç« ã€æœ€æ–°ç™»è¨˜æ’åºï¼‰ -->
            <div class="stack">
              <label>é¸æ“‡å‹•ç•«</label>
              <div class="select-anime" id="animeSelect">
                <button class="select-btn" id="animeSelectBtn" aria-haspopup="listbox" aria-expanded="false">
                  <div class="left">
                    <img alt="" src="assets/hero.svg">
                    <span class="name">ï¼ˆå°šç„¡ä½œå“ï¼Œè«‹å…ˆåˆ°ã€Œå‹•ç•«ç™»è¨˜ã€æ–°å¢ï¼‰</span>
                  </div>
                  <span class="badge">è§€çœ‹ 0 / 0</span>
                </button>
                <div class="select-list hidden" id="animeSelectList" role="listbox" tabindex="-1" aria-label="é¸æ“‡å‹•ç•«ï¼ˆä¸Šä¸‹éµç§»å‹•ï¼ŒEnter ç¢ºèªï¼‰"></div>
              </div>
              <small class="muted">æç¤ºï¼šå¯ç”¨éµç›¤ <span class="kbd">â†‘</span><span class="kbd">â†“</span> é¸å–ï¼Œ<span class="kbd">Enter</span> ç¢ºèªã€‚</small>
            </div>

            <!-- é›†æ•¸é¸æ“‡ï¼šç²¾ç°¡ï¼‹å€é–“è¼¸å…¥ï¼‹æ‰‹å‹•å‹¾é¸ï¼ˆæ”¶åˆï¼‰ -->
            <div class="stack">
              <div class="row" style="justify-content:space-between">
                <label>é¸æ“‡é›†æ•¸</label>
                <span class="muted" id="episodes-hint">å·²çœ‹ 0 / ç¸½ 0</span>
              </div>

              <!-- å€é–“å¿«é€Ÿæ–°å¢ -->
              <div class="row range-row">
                <input id="range-start" type="number" min="1" step="1" placeholder="èµ·å§‹">
                <span>â€”</span>
                <input id="range-end" type="number" min="1" step="1" placeholder="çµæŸ">
                <button id="range-submit" class="btn primary">åŠ å…¥</button>
                <span id="range-msg" class="muted" aria-live="polite"></span>
              </div>

              <!-- æ‰‹å‹•å‹¾é¸ï¼ˆchipsï¼Œé è¨­æ”¶åˆï¼‰ -->
              <details id="manual-details">
                <summary class="btn outline" style="display:inline-block">æ‰‹å‹•å‹¾é¸</summary>
                <div class="stack" style="margin-top:.75rem">
                  <div id="chips-container" class="chips"></div>
                  <div class="row">
                    <button id="manual-submit" class="btn">åŠ å…¥å‹¾é¸</button>
                    <span id="manual-msg" class="muted" aria-live="polite"></span>
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="row">
            <span id="record-msg" class="muted" aria-live="polite"></span>
          </div>
        </div>
      </section>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¬¬äºŒé ï¼šç™»è¨˜å‹•ç•« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="manage" class="container section">
        <h2>â‹ å‹•ç•«ç™»è¨˜ / ç®¡ç†</h2>
        <div class="row">
          <button id="open-create" class="btn primary">æ–°å¢å‹•ç•«</button>
          <span class="muted">æ–°å¢å¾Œæœƒå‡ºç¾åœ¨ã€Œå‹•ç•«ç´€éŒ„ã€èˆ‡ã€Œè§€çœ‹ç¸½è¦½ã€ã€‚</span>
        </div>

        <div class="section card stack">
          <h3>å·²ç™»è¨˜å‹•ç•«</h3>
          <div id="manage-list" class="manage-grid"></div>
        </div>

        <!-- å»ºç«‹å‹•ç•«å°è©±æ¡†ï¼ˆå–æ¶ˆå¯æ­£å¸¸é—œé–‰ï¼›æ–‡æ¡ˆå·²æ”¹ï¼‰ -->
        <dialog id="create-dialog">
          <form class="stack" id="create-form" method="dialog">
            <h3>æ–°å¢å‹•ç•«</h3>
            <label>å‹•ç•«åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰
              <input id="create-image" type="file" accept="image/*">
            </label>
            <label>å‹•ç•«åç¨±
              <input id="create-name" type="text" placeholder="ä¾‹å¦‚ï¼šæ˜Ÿéš›æ¼‚æµè¨˜" required>
            </label>
            <label>å‹•ç•«é›†æ•¸
              <input id="create-episodes" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹å¦‚ï¼š12" required>
            </label>
            <div class="row">
              <button class="btn primary" id="create-submit" type="button">å„²å­˜</button>
              <button class="btn" value="cancel" formmethod="dialog" type="submit">å–æ¶ˆ</button>
              <span id="create-msg" class="muted" aria-live="polite"></span>
            </div>
          </form>
        </dialog>
      </section>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¬¬ä¸‰é ï¼šç¸½è¦½ / æœå°‹ / åŒ¯å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <section id="dashboard" class="container section">
        <h2>âŒ è§€çœ‹ç¸½è¦½ / æœå°‹ / åŒ¯å‡º</h2>

        <div class="row">
          <button id="export-csv" class="btn outline">åŒ¯å‡ºè©¦ç®—è¡¨ï¼ˆCSVï¼‰</button>
          <span class="muted">ç›®å‰å…ˆè¼¸å‡º CSVï¼›æ ¼å¼ä¹‹å¾Œå¯å†èª¿æ•´ã€‚</span>
        </div>

        <div class="section">
          <h3>æœ€æ–°ç™»è¨˜çš„ 9 éƒ¨ä½œå“</h3>
          <div id="latest-grid" class="grid-3"></div>
        </div>

        <div class="section card">
          <h3>æœå°‹å…¶ä»–ä½œå“</h3>
          <div class="row" style="gap:.5rem">
            <input id="search-input" type="search" placeholder="è¼¸å…¥é—œéµå­—..." />
            <button id="search-clear" class="btn">æ¸…é™¤</button>
          </div>
          <div id="search-results" class="grid-3" style="margin-top:1rem"></div>
        </div>
      </section>
    </main>

    <footer class="site-footer container">
      <small>&copy; <span id="year"></span> å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨</small>
    </footer>

    <script src="script.js" defer></script>

    <script type="module">
      const DB_KEY = 'animeDB_v1';
      function loadDB(){ try { return JSON.parse(localStorage.getItem(DB_KEY)) ?? { items: [] }; } catch { return { items: [] }; } }
      function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
      function uid(){ return Math.random().toString(36).slice(2,10); }
      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

      document.getElementById('year').textContent = new Date().getFullYear();

      const sections = ['record','manage','dashboard'];
      function show(hash){
        const id = hash?.replace('#','') || 'record';
        sections.forEach(s => document.getElementById(s).classList.toggle('hidden', s !== id));
        history.replaceState(null,'', '#'+id);
      }
      window.addEventListener('hashchange', ()=> show(location.hash));
      show(location.hash);

      // å…ƒä»¶åƒç…§
      const animeSelectBtn  = document.getElementById('animeSelectBtn');
      const animeSelectList = document.getElementById('animeSelectList');
      const episodesHint    = document.getElementById('episodes-hint');
      const rangeStart      = document.getElementById('range-start');
      const rangeEnd        = document.getElementById('range-end');
      const rangeSubmit     = document.getElementById('range-submit');
      const rangeMsg        = document.getElementById('range-msg');
      const manualDetails   = document.getElementById('manual-details');
      const chipsContainer  = document.getElementById('chips-container');
      const manualSubmit    = document.getElementById('manual-submit');
      const recordMsg       = document.getElementById('record-msg');

      const openCreateBtn   = document.getElementById('open-create');
      const createDialog    = document.getElementById('create-dialog');
      const createForm      = document.getElementById('create-form');
      const createImage     = document.getElementById('create-image');
      const createName      = document.getElementById('create-name');
      const createEpsInput  = document.getElementById('create-episodes');
      const createSubmit    = document.getElementById('create-submit');
      const createMsg       = document.getElementById('create-msg');
      const manageList      = document.getElementById('manage-list');

      const latestGrid      = document.getElementById('latest-grid');
      const searchInput     = document.getElementById('search-input');
      const searchClear     = document.getElementById('search-clear');
      const searchResults   = document.getElementById('search-results');
      const exportBtn       = document.getElementById('export-csv');

      let currentAnimeId = null;

      function isComplete(a){ return (a.watched?.length||0) >= a.episodes && a.episodes>0; }
      function badgeHTML(a){
        return `<span class="badge ${isComplete(a)?'complete':''}">è§€çœ‹ ${a.watched?.length||0} / ${a.episodes}</span>`;
      }
      function nextUnwatched(a){
        const watched = new Set(a.watched||[]);
        for(let i=1;i<=a.episodes;i++){ if(!watched.has(i)) return i; }
        return null;
      }

      function refreshAll(){
        const db = loadDB();
        renderAnimeSelect(db);
        renderEpisodesUI(db);
        renderManageList(db);
        renderLatestGrid(db);
        renderSearchResults(db, searchInput.value?.trim() || '');
      }

      // A. è‡ªè¨‚å‹•ç•«ä¸‹æ‹‰
      function renderAnimeSelect(db){
        const items = db.items.slice().sort((a,b)=> b.createdAt - a.createdAt);
        animeSelectList.innerHTML = '';

        if(items.length === 0){
          animeSelectBtn.querySelector('.name').textContent = 'ï¼ˆå°šç„¡ä½œå“ï¼Œè«‹å…ˆåˆ°ã€Œå‹•ç•«ç™»è¨˜ã€æ–°å¢ï¼‰';
          animeSelectBtn.querySelector('img').src = 'assets/hero.svg';
          animeSelectBtn.querySelector('.badge').textContent = 'è§€çœ‹ 0 / 0';
          currentAnimeId = null;
          return;
        }

        // è‹¥ç›®å‰æœªé¸ä¸­ï¼Œé è¨­æœ€æ–°é‚£ç­†
        if(!items.some(x=> x.id === currentAnimeId)){
          currentAnimeId = items[0].id;
        }

        // æ¸…å–®
        for(const a of items){
          const row = document.createElement('div');
          row.className = 'select-item';
          row.setAttribute('role','option');
          row.dataset.id = a.id;
          row.innerHTML = `
            <div class="left">
              <img alt="" src="${a.image || 'assets/hero.svg'}">
              <div class="ellipsis-1">${a.name}</div>
            </div>
            ${badgeHTML(a)}
          `;
          row.addEventListener('click', ()=>{
            currentAnimeId = a.id;
            closeAnimeList();
            updateAnimeButton(a);
            renderEpisodesUI(loadDB()); // ç«‹å³åˆ·æ–° chips/æç¤º
          });
          animeSelectList.appendChild(row);
        }

        // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
        const cur = db.items.find(x=> x.id === currentAnimeId);
        if(cur) updateAnimeButton(cur);
      }
      function updateAnimeButton(a){
        animeSelectBtn.querySelector('img').src = a.image || 'assets/hero.svg';
        animeSelectBtn.querySelector('.name').textContent = a.name;
        const b = animeSelectBtn.querySelector('.badge');
        b.innerHTML = `è§€çœ‹ ${a.watched?.length||0} / ${a.episodes}`;
        b.classList.toggle('complete', isComplete(a));
        animeSelectBtn.setAttribute('aria-expanded','false');
      }
      function openAnimeList(){
        animeSelectList.classList.remove('hidden');
        animeSelectBtn.setAttribute('aria-expanded','true');
        animeSelectList.focus();
      }
      function closeAnimeList(){
        animeSelectList.classList.add('hidden');
        animeSelectBtn.setAttribute('aria-expanded','false');
      }
      animeSelectBtn.addEventListener('click', ()=>{
        const open = animeSelectBtn.getAttribute('aria-expanded') === 'true';
        open ? closeAnimeList() : openAnimeList();
      });
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#animeSelect')) closeAnimeList();
      });

      // B. é›†æ•¸å€åŸŸï¼ˆå€é–“ + æ‰‹å‹• chipsï¼‰
      function renderEpisodesUI(db){
        const a = db.items.find(x=> x.id === currentAnimeId);
        rangeMsg.textContent = '';
        document.getElementById('manual-msg').textContent = '';
        recordMsg.textContent = '';

        if(!a){
          episodesHint.textContent = 'å·²çœ‹ 0 / ç¸½ 0';
          rangeStart.value = ''; rangeEnd.value = '';
          chipsContainer.innerHTML = '';
          return;
        }
        episodesHint.textContent = `å·²çœ‹ ${a.watched?.length||0} / ç¸½ ${a.episodes}`;

        // é å¡«ï¼šä¸‹ä¸€æœªè§€çœ‹
        const next = nextUnwatched(a) ?? 1;
        rangeStart.min = '1'; rangeStart.max = String(a.episodes);
        rangeEnd.min   = '1'; rangeEnd.max   = String(a.episodes);
        rangeStart.value = String(next);
        rangeEnd.value   = String(next);

        // ç”¢ç”Ÿ chipsï¼ˆåªé¡¯ç¤ºæœªè§€çœ‹ï¼‰
        const watched = new Set(a.watched||[]);
        chipsContainer.innerHTML = '';
        const frag = document.createDocumentFragment();
        for(let i=1;i<=a.episodes;i++){
          if(watched.has(i)) continue;
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = 'Ep'+i;
          chip.dataset.ep = String(i);
          chip.addEventListener('click', ()=> chip.classList.toggle('selected'));
          frag.appendChild(chip);
        }
        chipsContainer.appendChild(frag);
        if(!frag.childNodes.length){
          chipsContainer.innerHTML = '<span class="muted">æœ¬ä½œå“å·²å…¨éƒ¨çœ‹å®Œ ğŸ‰</span>';
        }
      }

      rangeSubmit.addEventListener('click', ()=>{
        const db = loadDB();
        const a = db.items.find(x=> x.id === currentAnimeId);
        if(!a){ rangeMsg.textContent = 'è«‹å…ˆé¸æ“‡å‹•ç•«ã€‚'; return; }

        let s = parseInt(rangeStart.value,10);
        let e = parseInt(rangeEnd.value,10);
        if(!Number.isFinite(s) || !Number.isFinite(e)){ rangeMsg.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·è¨–é›†æ•¸ã€‚'; return; }

        s = clamp(s, 1, a.episodes);
        e = clamp(e, 1, a.episodes);
        if(s > e){ [s,e] = [e,s]; }

        const watched = new Set(a.watched||[]);
        const all = [], conflicts = [];
        for(let i=s;i<=e;i++){ (watched.has(i) ? conflicts : all).push(i); }
        if(conflicts.length){
          rangeMsg.textContent = `å·²æœ‰ç´€éŒ„ï¼š${conflicts.map(n=>'Ep'+n).join(', ')}ã€‚è«‹èª¿æ•´å€é–“å¾Œå†è©¦ã€‚`;
          return;
        }
        if(all.length===0){ rangeMsg.textContent = 'æ­¤å€é–“æ²’æœ‰å¯æ–°å¢çš„é›†æ•¸ã€‚'; return; }

        a.watched = Array.from(new Set([...(a.watched||[]), ...all])).sort((x,y)=>x-y);
        a.updatedAt = Date.now();
        saveDB(db);
        rangeMsg.textContent = `å·²åŠ å…¥ï¼š${all.map(n=>'Ep'+n).join(', ')}`;
        renderEpisodesUI(db);
        renderLatestGrid(db);
        renderAnimeSelect(db);
      });

      manualSubmit.addEventListener('click', ()=>{
        const db = loadDB();
        const a = db.items.find(x=> x.id === currentAnimeId);
        const manualMsg = document.getElementById('manual-msg');
        if(!a){ manualMsg.textContent = 'è«‹å…ˆé¸æ“‡å‹•ç•«ã€‚'; return; }
        const selected = Array.from(chipsContainer.querySelectorAll('.chip.selected')).map(x=> Number(x.dataset.ep));
        if(selected.length===0){ manualMsg.textContent = 'è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€é›†ã€‚'; return; }
        a.watched = Array.from(new Set([...(a.watched||[]), ...selected])).sort((x,y)=>x-y);
        a.updatedAt = Date.now();
        saveDB(db);
        manualMsg.textContent = `å·²åŠ å…¥ï¼š${selected.map(n=>'Ep'+n).join(', ')}`;
        renderEpisodesUI(db);
        renderLatestGrid(db);
        renderAnimeSelect(db);
      });

      // C. ç™»è¨˜é 
      function renderManageList(db){
        manageList.innerHTML = '';
        if(db.items.length === 0){
          manageList.innerHTML = '<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>';
          return;
        }
        const items = db.items.slice().sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'));
        for(const a of items){
          const card = document.createElement('article');
          card.className = 'manage-card';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="stack">
              <div class="title-row">
                <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
                ${badgeHTML(a)}
              </div>
              <small class="muted">å…± ${a.episodes} é›† Â· å·²çœ‹ ${a.watched?.length||0} é›†</small>
            </div>
            <button class="icon-btn" title="åˆªé™¤" aria-label="åˆªé™¤">
              <svg class="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          `;
          card.querySelector('.icon-btn').addEventListener('click', ()=>{
            if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${a.name}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)){
              const idx = db.items.findIndex(x=>x.id===a.id);
              if(idx>-1){ db.items.splice(idx,1); saveDB(db); refreshAll(); }
            }
          });
          manageList.appendChild(card);
        }
      }

      // D. æ–°å¢å‹•ç•«ï¼ˆä¿®æ­£ï¼šæ–°å¢å¾Œè‡ªå‹•é¸ä¸­è©²ä½œå“ä¸¦å…¨åŸŸåˆ·æ–°ï¼‰
      openCreateBtn.addEventListener('click', ()=> {
        createForm.reset();
        createMsg.textContent = '';
        createDialog.showModal();
      });
      createSubmit.addEventListener('click', async ()=>{
        createMsg.textContent = '';
        const name = createName.value.trim();
        const eps  = createEpsInput.value.trim();
        if(!name){ createMsg.textContent = 'è«‹è¼¸å…¥åç¨±'; return; }
        if(!/^[0-9]+$/.test(eps)){ createMsg.textContent = 'é›†æ•¸åƒ…èƒ½è¼¸å…¥æ•¸å­—'; return; }
        const episodes = Math.max(1, parseInt(eps,10));

        const db = loadDB();
        if(db.items.some(x=> x.name === name)){
          createMsg.textContent = 'æ­¤åç¨±å·²å­˜åœ¨ï¼Œè‹¥è¦é‡æ–°ä¸Šå‚³è«‹å…ˆåˆªé™¤èˆŠè³‡æ–™ã€‚';
          return;
        }

        let imageData = null;
        const file = createImage.files?.[0];
        if(file){ imageData = await fileToDataURL(file); }

        const id = uid();
        db.items.push({
          id, name, episodes,
          image: imageData || undefined,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          watched: []
        });
        saveDB(db);
        currentAnimeId = id;                // â¬… æ–°å¢ï¼šè‡ªå‹•é¸ä¸­é€™ç­†
        createDialog.close();
        refreshAll();                       // â¬… ç¢ºä¿ä¸‰é éƒ½æ›´æ–°
      });

      function fileToDataURL(file){
        return new Promise((res,rej)=>{
          const r = new FileReader();
          r.onload = ()=> res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }

      // E. ç¸½è¦½
      function renderLatestGrid(db){
        latestGrid.innerHTML = '';
        if(db.items.length === 0){
          latestGrid.innerHTML = '<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>';
          return;
        }
        const top9 = db.items.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0,9);
        for(const a of top9){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
              ${badgeHTML(a)}
            </div>
          `;
          latestGrid.appendChild(card);
        }
      }
      function renderSearchResults(db, keyword){
        searchResults.innerHTML = '';
        const list = db.items.slice();
        const kw = (keyword||'').trim();
        const results = !kw ? [] : list.filter(a =>
          a.name.toLowerCase().includes(kw.toLowerCase())
        );
        if(!kw){ return; }
        if(results.length === 0){
          searchResults.innerHTML = '<div class="muted">æ²’æœ‰ç¬¦åˆçš„ä½œå“ã€‚</div>';
          return;
        }
        for(const a of results){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
              ${badgeHTML(a)}
            </div>
          `;
          searchResults.appendChild(card);
        }
      }
      searchInput.addEventListener('input', ()=> renderSearchResults(loadDB(), searchInput.value));
      searchClear.addEventListener('click', ()=>{
        searchInput.value = '';
        renderSearchResults(loadDB(), '');
      });

      // é¦–æ¬¡è¼‰å…¥
      refreshAll();
    </script>
  </body>
</html>
