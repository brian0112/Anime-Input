<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>動畫進度</title>
    <meta name="description" content="登記動畫、輸入觀看紀錄、週次總覽與匯出。"/>
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <meta property="og:title" content="動畫進度" />
    <meta property="og:description" content="登記動畫、輸入觀看紀錄、週次總覽與匯出。"/>
    <meta property="og:type" content="website" />
    <style>
      .tabs { display:flex; gap:.5rem; flex-wrap:wrap; }
      .tabs a { text-decoration:none; }
      .hidden{ display:none !important }
      .stack{ display:grid; gap:1rem }
      .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap }
      .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
      .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem }
      .pill{ border:1px solid var(--border); padding:.25rem .6rem; border-radius:999px; font-size:.9rem; color:var(--muted)}
      .muted{ color:var(--muted) }
      .thumb{ width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:.75rem; border:1px solid var(--border); background:#0002 }
      .badge{ font-size:.8rem; padding:.2rem .5rem; border-radius:.5rem; border:1px solid var(--border); }
      .badge.complete{ background:var(--brand); color:var(--brand-ink); border-color:transparent; font-weight:700; }
      dialog{ border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:1rem; padding:1rem; max-width:560px }
      dialog::backdrop{ background: rgba(0,0,0,.4) }

      /* 自訂動畫下拉（帶縮圖） */
      .select-anime { position:relative; }
      .select-btn { width:100%; display:flex; align-items:center; justify-content:space-between; gap:.75rem; border:1px solid var(--border); background:transparent; color:var(--text); padding:.6rem .9rem; border-radius:.8rem; cursor:pointer; }
      .select-btn .left { display:flex; align-items:center; gap:.75rem; min-width:0; }
      .select-btn img { width:36px; height:36px; border-radius:.5rem; object-fit:cover; border:1px solid var(--border); }
      .select-btn .name { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .select-list { position:absolute; z-index:20; inset: auto 0 0 0; transform: translateY(100%); background:var(--panel); border:1px solid var(--border); border-radius:.8rem; padding:.4rem; max-height:300px; overflow:auto; box-shadow: 0 10px 30px #0005; }
      .select-item { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem .6rem; border-radius:.6rem; cursor:pointer; }
      .select-item:hover{ background:#ffffff10 }
      .select-item .left{ display:flex; align-items:center; gap:.6rem; }
      .select-item img { width:40px; height:40px; border-radius:.5rem; object-fit:cover; border:1px solid var(--border); }
      .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.8rem; padding:.1rem .35rem; border:1px solid var(--border); border-radius:.35rem; color:var(--muted) }

      /* 集數控制列 */
      .range-row input[type="number"]{ width:6rem; }

      /* 管理頁卡片：兩欄、左圖右文，右上紅色垃圾桶 */
      :root{ --danger:#ef4444; --danger-ink:#ffffff; }
      .manage-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:1rem }
      .manage-card{ display:grid; grid-template-columns: 1.3fr 1fr; gap:1rem; border:1px solid var(--border); background:var(--panel); border-radius:1rem; padding:1rem; position:relative; }
      .manage-card .thumb{ aspect-ratio:16/9; width:100%; }
      .manage-card .right{ display:grid; gap:.5rem; padding-right:2.4rem; } /* 右上角保留空間給垃圾桶 */
      .manage-card .title-row{ display:flex; justify-content:space-between; gap:.75rem; align-items:flex-start }
      .icon-btn{ position:absolute; top:.6rem; right:.6rem; border:1px solid transparent; background:var(--danger); color:var(--danger-ink); border-radius:.6rem; padding:.45rem; cursor:pointer; z-index:2; box-shadow:0 4px 14px rgba(239,68,68,.35); }
      .icon-btn:hover{ filter:brightness(1.1) }
      .icon-trash{ width:18px; height:18px; display:block }
      .ellipsis-1{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }

      @media (max-width: 1024px){
        .two-col{ grid-template-columns:1fr }
        .grid-3{ grid-template-columns:1fr }
        .manage-grid{ grid-template-columns:1fr }
      }
    </style>
  </head>
  <body>
    <header class="site-header container">
      <a class="brand" href="#record" aria-label="首頁">🎞️ 動畫進度</a>
      <nav class="nav tabs" aria-label="主選單">
        <a href="#record" class="pill">動畫紀錄</a>
        <a href="#manage" class="pill">動畫登記</a>
        <a href="#dashboard" class="pill">觀看總覽</a>
      </nav>
      <button id="themeToggle" class="btn outline" aria-pressed="false" aria-label="切換深淺色">主題</button>
    </header>

    <main id="app">
      <!-- ───────────────────────────────── 主頁：輸入觀看紀錄 ───────────────────────────────── -->
      <section id="record" class="container section">
        <h2>➊ 輸入「動畫紀錄」</h2>
        <div class="card stack">
          <div class="two-col">
            <!-- 動畫選擇 -->
            <div class="stack">
              <label>選擇動畫</label>
              <div class="select-anime" id="animeSelect">
                <button class="select-btn" id="animeSelectBtn" aria-haspopup="listbox" aria-expanded="false">
                  <div class="left">
                    <img alt="" src="assets/hero.svg">
                    <span class="name">（尚無作品，請先到「動畫登記」新增）</span>
                  </div>
                  <span class="badge">觀看 0 / 0</span>
                </button>
                <div class="select-list hidden" id="animeSelectList" role="listbox" tabindex="-1" aria-label="選擇動畫（上下鍵移動，Enter 確認）"></div>
              </div>
              <small class="muted">鍵盤 <span class="kbd">↑</span><span class="kbd">↓</span> 選取，<span class="kbd">Enter</span> 確認。</small>
            </div>

            <!-- 集數選擇（週次在上方 + 區間輸入） -->
            <div class="stack">
              <!-- 週次選擇（最近 12 週，週一→週日） -->
              <div class="row">
                <label>選擇週次</label>
                <select id="week-select"></select>
              </div>

              <div class="row" style="justify-content:space-between">
                <label>選擇集數</label>
                <span class="muted" id="episodes-hint">已看 0 / 總 0</span>
              </div>

              <div class="row range-row">
                <input id="range-start" type="number" min="1" step="1" placeholder="起始">
                <span>—</span>
                <input id="range-end" type="number" min="1" step="1" placeholder="結束">
                <button id="range-submit" class="btn primary">加入</button>
                <span id="range-msg" class="muted" aria-live="polite"></span>
              </div>
            </div>
          </div>

          <div class="row">
            <span id="record-msg" class="muted" aria-live="polite"></span>
          </div>
        </div>
      </section>

      <!-- ───────────────────────────────── 第二頁：登記動畫 ───────────────────────────────── -->
      <section id="manage" class="container section">
        <h2>➋ 動畫登記 / 管理</h2>
        <div class="row">
          <button id="open-create" class="btn primary">新增動畫</button>
          <span class="muted">新增後會出現在「動畫紀錄」與「觀看總覽」。</span>
        </div>

        <div class="section card stack">
          <h3>已登記動畫</h3>
          <div id="manage-list" class="manage-grid"></div>
        </div>

        <!-- 建立動畫對話框（取消可正常關閉） -->
        <dialog id="create-dialog">
          <form class="stack" id="create-form" method="dialog">
            <h3>新增動畫</h3>
            <label>動畫圖片（選填）
              <input id="create-image" type="file" accept="image/*">
            </label>
            <label>動畫名稱
              <input id="create-name" type="text" placeholder="例如：星際漂流記" required>
            </label>
            <label>動畫集數
              <input id="create-episodes" inputmode="numeric" pattern="[0-9]*" placeholder="例如：12" required>
            </label>
            <div class="row">
              <button class="btn primary" id="create-submit" type="button">儲存</button>
              <button class="btn" id="create-cancel" type="button">取消</button>
              <span id="create-msg" class="muted" aria-live="polite"></span>
            </div>
          </form>
        </dialog>
      </section>

      <!-- ───────────────────────────────── 第三頁：總覽 / 搜尋 / 匯出 ───────────────────────────────── -->
      <section id="dashboard" class="container section">
        <h2>➌ 觀看總覽 / 搜尋 / 匯出</h2>

        <div class="row" style="gap:.5rem; flex-wrap:wrap">
          <button id="export-csv-week" class="btn outline">匯出本週（CSV）</button>
          <button id="export-csv-all" class="btn outline">匯出全部週次（多檔 CSV）</button>
          <span class="muted">E 欄的「速度評價」稍後依你規則更新。</span>
        </div>

        <div class="section">
          <h3>最新登記的 9 部作品</h3>
          <div id="latest-grid" class="grid-3"></div>
        </div>

        <div class="section card">
          <h3>搜尋其他作品</h3>
          <div class="row" style="gap:.5rem">
            <input id="search-input" type="search" placeholder="輸入關鍵字..." />
            <button id="search-clear" class="btn">清除</button>
          </div>
          <div id="search-results" class="grid-3" style="margin-top:1rem"></div>
        </div>
      </section>
    </main>

    <footer class="site-footer container">
      <small>&copy; <span id="year"></span> 動畫進度 · 由你打造 ✨</small>
    </footer>

    <!-- Starter 腳本 -->
    <script src="script.js" defer></script>

    <!-- 本頁專用邏輯 -->
    <script type="module">
      const DB_KEY = 'animeDB_v2'; // 升版：加入 logs
      /**
       * DB 結構：
       * { items: [{id,name,episodes,image,createdAt,updatedAt,watched:number[]}],
       *   logs: [{animeId, weekStartISO, eps:number[], createdAt:number}] }
       */
      function loadDB(){
        let db;
        try { db = JSON.parse(localStorage.getItem(DB_KEY)); } catch {}
        if(!db){
          // 從 v1 遷移（若存在）
          try {
            const v1 = JSON.parse(localStorage.getItem('animeDB_v1'));
            if(v1 && v1.items){ db = { items: v1.items, logs: [] }; }
          } catch {}
        }
        return db ?? { items: [], logs: [] };
      }
      function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
      function uid(){ return Math.random().toString(36).slice(2,10); }
      document.getElementById('year').textContent = new Date().getFullYear();

      // ── 週次工具（台北時區，以本地時間計）──
      function toYMD(d){ return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'); }
      function mondayOf(d){
        const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const day = x.getDay(); // 0 日 ~ 6 六
        const offset = (day+6)%7; // 週一=0
        x.setDate(x.getDate()-offset);
        x.setHours(0,0,0,0);
        return x;
      }
      function sundayOf(d){
        const m = mondayOf(d);
        const s = new Date(m);
        s.setDate(m.getDate()+6); s.setHours(23,59,59,999);
        return s;
      }
      function weekLabel(d){
        const m = mondayOf(d);
        const s = sundayOf(d);
        const fmt = (dt)=> String(dt.getMonth()+1).padStart(2,'0')+'/'+String(dt.getDate()).padStart(2,'0');
        return `${fmt(m)}–${fmt(s)}`;
      }
      function weekStartISOFromDate(d){ return mondayOf(d).toISOString(); }
      function formatWeekRangeFromISO(iso){
        const d = new Date(iso);
        return weekLabel(d);
      }
      function recentWeeks(n=12){
        const arr = [];
        const now = new Date();
        const thisMon = mondayOf(now);
        for(let i=0;i<n;i++){
          const start = new Date(thisMon);
          start.setDate(thisMon.getDate()-7*i);
          arr.push(start);
        }
        return arr;
      }

      // ── DOM 參照 ──
      const weekSelect      = document.getElementById('week-select');
      const animeSelectBtn  = document.getElementById('animeSelectBtn');
      const animeSelectList = document.getElementById('animeSelectList');
      const episodesHint    = document.getElementById('episodes-hint');
      const rangeStart      = document.getElementById('range-start');
      const rangeEnd        = document.getElementById('range-end');
      const rangeSubmit     = document.getElementById('range-submit');
      const rangeMsg        = document.getElementById('range-msg');
      const recordMsg       = document.getElementById('record-msg');

      const openCreateBtn   = document.getElementById('open-create');
      const createDialog    = document.getElementById('create-dialog');
      const createForm      = document.getElementById('create-form');
      const createImage     = document.getElementById('create-image');
      const createName      = document.getElementById('create-name');
      const createEpsInput  = document.getElementById('create-episodes');
      const createSubmit    = document.getElementById('create-submit');
      const createCancel    = document.getElementById('create-cancel');
      const createMsg       = document.getElementById('create-msg');
      const manageList      = document.getElementById('manage-list');

      const latestGrid      = document.getElementById('latest-grid');
      const searchInput     = document.getElementById('search-input');
      const searchClear     = document.getElementById('search-clear');
      const searchResults   = document.getElementById('search-results');
      const exportWeekBtn   = document.getElementById('export-csv-week');
      const exportAllBtn    = document.getElementById('export-csv-all');

      // 狀態
      let currentAnimeId = null;

      // ── 共用小工具 ──
      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
      function fileToDataURL(file){
        return new Promise((res,rej)=>{
          const r = new FileReader();
          r.onload = ()=> res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }
      function isComplete(a){ return (a.watched?.length||0) >= a.episodes && a.episodes>0; }
      function badgeHTML(a){
        return `<span class="badge ${isComplete(a)?'complete':''}">觀看 ${a.watched?.length||0} / ${a.episodes}</span>`;
      }
      function nextUnwatched(a){
        const watched = new Set(a.watched||[]);
        for(let i=1;i<=a.episodes;i++){ if(!watched.has(i)) return i; }
        return null;
      }

      // ── 初始化週次下拉（最近 12 週，預設本週）──
      function renderWeekSelect(){
        const weeks = recentWeeks(12);
        weekSelect.innerHTML = '';
        weeks.forEach((startDate, idx)=>{
          const opt = new Option(weekLabel(startDate), weekStartISOFromDate(startDate));
          if(idx===0) opt.selected = true; // 本週
          weekSelect.add(opt);
        });
      }

      // ── 畫面刷新 ──
      function refreshAll(){
        const db = loadDB();
        renderWeekSelectIfEmpty();
        renderAnimeSelect(db);
        renderEpisodesUI(db);
        renderManageList(db);
        renderLatestGrid(db);
        renderSearchResults(db, searchInput.value?.trim() || '');
      }
      function renderWeekSelectIfEmpty(){
        if(weekSelect.options.length === 0) renderWeekSelect();
      }

      // A. 自訂動畫下拉
      function renderAnimeSelect(db){
        const items = db.items.slice().sort((a,b)=> b.createdAt - a.createdAt);
        animeSelectList.innerHTML = '';

        if(items.length === 0){
          animeSelectBtn.querySelector('.name').textContent = '（尚無作品，請先到「動畫登記」新增）';
          animeSelectBtn.querySelector('img').src = 'assets/hero.svg';
          animeSelectBtn.querySelector('.badge').textContent = '觀看 0 / 0';
          currentAnimeId = null;
          return;
        }
        if(!items.some(x=> x.id === currentAnimeId)){
          currentAnimeId = items[0].id;
        }
        for(const a of items){
          const row = document.createElement('div');
          row.className = 'select-item';
          row.setAttribute('role','option');
          row.dataset.id = a.id;
          row.innerHTML = `
            <div class="left">
              <img alt="" src="${a.image || 'assets/hero.svg'}">
              <div class="ellipsis-1">${a.name}</div>
            </div>
            ${badgeHTML(a)}
          `;
          row.addEventListener('click', ()=>{
            currentAnimeId = a.id;
            closeAnimeList();
            updateAnimeButton(a);
            renderEpisodesUI(loadDB());
          });
          animeSelectList.appendChild(row);
        }
        const cur = db.items.find(x=> x.id === currentAnimeId);
        if(cur) updateAnimeButton(cur);
      }
      function updateAnimeButton(a){
        animeSelectBtn.querySelector('img').src = a.image || 'assets/hero.svg';
        animeSelectBtn.querySelector('.name').textContent = a.name;
        const b = animeSelectBtn.querySelector('.badge');
        b.innerHTML = `觀看 ${a.watched?.length||0} / ${a.episodes}`;
        b.classList.toggle('complete', isComplete(a));
        animeSelectBtn.setAttribute('aria-expanded','false');
      }
      function openAnimeList(){
        animeSelectList.classList.remove('hidden');
        animeSelectBtn.setAttribute('aria-expanded','true');
        animeSelectList.focus();
      }
      function closeAnimeList(){
        animeSelectList.classList.add('hidden');
        animeSelectBtn.setAttribute('aria-expanded','false');
      }
      animeSelectBtn.addEventListener('click', ()=>{
        const open = animeSelectBtn.getAttribute('aria-expanded') === 'true';
        open ? closeAnimeList() : openAnimeList();
      });
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#animeSelect')) closeAnimeList();
      });

      // B. 集數區域（僅區間；依週記錄）
      function renderEpisodesUI(db){
        const a = db.items.find(x=> x.id === currentAnimeId);
        rangeMsg.textContent = '';
        recordMsg.textContent = '';

        if(!a){
          episodesHint.textContent = '已看 0 / 總 0';
          rangeStart.value = ''; rangeEnd.value = '';
          return;
        }
        episodesHint.textContent = `已看 ${a.watched?.length||0} / 總 ${a.episodes}`;

        const next = nextUnwatched(a) ?? 1;
        rangeStart.min = '1'; rangeStart.max = String(a.episodes);
        rangeEnd.min   = '1'; rangeEnd.max   = String(a.episodes);
        rangeStart.value = String(next);
        rangeEnd.value   = String(next);
      }

      rangeSubmit.addEventListener('click', ()=>{
        const db = loadDB();
        const a = db.items.find(x=> x.id === currentAnimeId);
        if(!a){ rangeMsg.textContent = '請先選擇動畫。'; return; }

        const weekStartISO = weekSelect.value; // 以選取週次存檔
        let s = parseInt(rangeStart.value,10);
        let e = parseInt(rangeEnd.value,10);
        if(!Number.isFinite(s) || !Number.isFinite(e)){ rangeMsg.textContent = '請輸入有效的起訖集數。'; return; }

        s = clamp(s, 1, a.episodes);
        e = clamp(e, 1, a.episodes);
        if(s > e){ [s,e] = [e,s]; }

        const watched = new Set(a.watched||[]);
        const all = [], conflicts = [];
        for(let i=s;i<=e;i++){ (watched.has(i) ? conflicts : all).push(i); }
        if(conflicts.length){
          rangeMsg.textContent = `已有紀錄：${conflicts.map(n=>'Ep'+n).join(', ')}。請調整區間後再試。`;
          return;
        }
        if(all.length===0){ rangeMsg.textContent = '此區間沒有可新增的集數。'; return; }

        // 更新全域 watched
        a.watched = Array.from(new Set([...(a.watched||[]), ...all])).sort((x,y)=>x-y);
        a.updatedAt = Date.now();

        // 週誌：若同一週同一作品已存在，就合併 ep（去重）
        const key = { animeId:a.id, weekStartISO };
        const exist = db.logs.find(l => l.animeId===key.animeId && l.weekStartISO===key.weekStartISO);
        if(exist){
          exist.eps = Array.from(new Set([...(exist.eps||[]), ...all])).sort((x,y)=>x-y);
          exist.createdAt = Date.now();
        }else{
          db.logs.push({ animeId:a.id, weekStartISO, eps: all.slice().sort((x,y)=>x-y), createdAt: Date.now() });
        }

        saveDB(db);
        rangeMsg.textContent = `已加入：${all.map(n=>'Ep'+n).join(', ')}（週次：${formatWeekRangeFromISO(weekStartISO)}）`;
        renderEpisodesUI(db);
        renderLatestGrid(db);
        renderAnimeSelect(db);
      });

      weekSelect.addEventListener('change', ()=> {
        // 切週次不影響 watched，只影響提示與匯出/寫入位置
        rangeMsg.textContent = '';
      });

      // C. 登記頁
      function renderManageList(db){
        manageList.innerHTML = '';
        if(db.items.length === 0){
          manageList.innerHTML = '<div class="muted">尚未登記任何動畫。</div>';
          return;
        }
        const items = db.items.slice().sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'));
        for(const a of items){
          const card = document.createElement('article');
          card.className = 'manage-card';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="right">
              <div class="title-row">
                <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
                ${badgeHTML(a)}
              </div>
              <small class="muted">共 ${a.episodes} 集 · 已看 ${a.watched?.length||0} 集</small>
            </div>
            <button class="icon-btn" title="刪除" aria-label="刪除">
              <svg class="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          `;
          card.querySelector('.icon-btn').addEventListener('click', ()=>{
            if(confirm(`確定要刪除「${a.name}」嗎？此動作無法復原。`)){
              const idx = db.items.findIndex(x=>x.id===a.id);
              if(idx>-1){
                db.items.splice(idx,1);
                // 同步移除該作品的週誌
                db.logs = db.logs.filter(l => l.animeId !== a.id);
                saveDB(db);
                refreshAll();
              }
            }
          });
          manageList.appendChild(card);
        }
      }

      // 新增動畫（取消一定關）
      openCreateBtn.addEventListener('click', ()=> {
        createForm.reset();
        createMsg.textContent = '';
        createDialog.showModal();
      });
      createCancel.addEventListener('click', ()=> {
        createDialog.close();
      });
      createDialog.addEventListener('cancel', (e)=>{ /* Esc 關閉 */ e.preventDefault(); createDialog.close(); });

      createSubmit.addEventListener('click', async ()=>{
        createMsg.textContent = '';
        const name = createName.value.trim();
        const eps  = createEpsInput.value.trim();
        if(!name){ createMsg.textContent = '請輸入名稱'; return; }
        if(!/^[0-9]+$/.test(eps)){ createMsg.textContent = '集數僅能輸入數字'; return; }
        const episodes = Math.max(1, parseInt(eps,10));

        const db = loadDB();
        if(db.items.some(x=> x.name === name)){ createMsg.textContent = '此名稱已存在，若要重新上傳請先刪除舊資料。'; return; }

        let imageData = null;
        const file = createImage.files?.[0];
        if(file){ imageData = await fileToDataURL(file); }

        const id = uid();
        db.items.push({ id, name, episodes, image: imageData || undefined, createdAt: Date.now(), updatedAt: Date.now(), watched: [] });
        saveDB(db);
        currentAnimeId = id;
        createDialog.close();
        refreshAll();
      });

      // D. 總覽（最新 9 部）
      function renderLatestGrid(db){
        latestGrid.innerHTML = '';
        if(db.items.length === 0){
          latestGrid.innerHTML = '<div class="muted">尚未登記任何動畫。</div>';
          return;
        }
        const top9 = db.items.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0,9);
        for(const a of top9){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
              ${badgeHTML(a)}
            </div>
          `;
          latestGrid.appendChild(card);
        }
      }
      function renderSearchResults(db, keyword){
        searchResults.innerHTML = '';
        const list = db.items.slice();
        const kw = (keyword||'').trim();
        const results = !kw ? [] : list.filter(a => a.name.toLowerCase().includes(kw.toLowerCase()));
        if(!kw){ return; }
        if(results.length === 0){
          searchResults.innerHTML = '<div class="muted">沒有符合的作品。</div>';
          return;
        }
        for(const a of results){
          const card = document.createElement('article');
          card.className = 'card stack';
          card.innerHTML = `
            <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
            <div class="row" style="justify-content:space-between">
              <strong class="ellipsis-1" title="${a.name}">${a.name}</strong>
              ${badgeHTML(a)}
            </div>
          `;
          searchResults.appendChild(card);
        }
      }
      searchInput.addEventListener('input', ()=> renderSearchResults(loadDB(), searchInput.value));
      searchClear.addEventListener('click', ()=>{ searchInput.value = ''; renderSearchResults(loadDB(), ''); });

      // E. 匯出（單週 / 全部週次）
      function csvEscape(v){ const s = String(v ?? ''); return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; }
      function compressToRanges(nums){
        // 輸入排序後的數列，輸出 ["5~7","9","12~13"] 這種片段
        if(nums.length===0) return [];
        const a = nums.slice().sort((x,y)=>x-y);
        const out = [];
        let start = a[0], prev = a[0];
        for(let i=1;i<a.length;i++){
          const cur = a[i];
          if(cur === prev + 1){ prev = cur; continue; }
          out.push(start===prev ? String(start) : `${start}~${prev}`);
          start = prev = cur;
        }
        out.push(start===prev ? String(start) : `${start}~${prev}`);
        return out;
      }
      function exportWeekCSV(weekStartISO){
        const db = loadDB();
        const rows = [['動漫','集數','進度(第X集)','', '速度評價(Y集)']];
        const logs = db.logs.filter(l => l.weekStartISO === weekStartISO);
        // 以作品聚合
        const byAnime = new Map();
        for(const l of logs){
          const eps = byAnime.get(l.animeId) || new Set();
          (l.eps||[]).forEach(x=> eps.add(x));
          byAnime.set(l.animeId, eps);
        }
        let sum = 0;
        for(const [animeId, epsSet] of byAnime.entries()){
          const a = db.items.find(x=> x.id===animeId);
          const eps = Array.from(epsSet).sort((x,y)=>x-y);
          const ranges = compressToRanges(eps);
          const count = eps.length;
          rows.push([ a?.name ?? animeId, String(count), ranges.join(','), '', `（${count}集）` ]);
          sum += count;
        }
        rows.push(['總計', String(sum)]);
        const csv = rows.map(r=> r.map(csvEscape).join(',')).join('\r\n');
        const filename = `anime_watch_${formatWeekRangeFromISO(weekStartISO).replace(/[^\d~–]/g,'').replace('–','-')}.csv`;
        downloadText(csv, filename);
      }
      function exportAllWeeksCSV(){
        const db = loadDB();
        const weeks = Array.from(new Set(db.logs.map(l=> l.weekStartISO))).sort(); // 舊→新
        for(const w of weeks){ exportWeekCSV(w); }
      }
      function downloadText(text, filename){
        const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }

      exportWeekBtn.addEventListener('click', ()=> {
        const weekStartISO = weekSelect.value || weekStartISOFromDate(new Date());
        exportWeekCSV(weekStartISO);
      });
      exportAllBtn.addEventListener('click', ()=> exportAllWeeksCSV());

      // ── 首次載入 ──
      refreshAll();
    </script>
  </body>
</html>
