<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>觀看總覽</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div data-include="header.html"></div>

  <main class="container">
    <section class="section">
      <div class="row">
        <label style="margin:0">
          <span class="muted">選擇週次</span>
          <select id="week"></select>
        </label>
        <button id="expWeek" class="btn">匯出此週 CSV</button>
        <button id="expAll" class="btn">全部週次各自一張 CSV</button>
        <button id="refresh" class="btn primary">雲端重新整理</button>
        <span id="hint" class="muted"></span>
      </div>
    </section>

    <section class="section">
      <h2>最新登記的 9 部作品</h2>
      <div id="latest" class="grid"></div>
    </section>

    <section class="section">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">搜尋</h2>
        <input id="q" type="search" placeholder="輸入動畫名稱…">
      </div>
      <div id="result" class="grid" style="margin-top:1rem"></div>
    </section>
  </main>

  <footer class="site-footer container">
    <small>© 動畫進度 · 由你打造 ✨</small>
  </footer>

  <!-- 載入共用 header -->
  <script>
    (function loadSharedPart(){
      const ts = (window.__BUILD_TS || Date.now());
      document.querySelectorAll('[data-include]').forEach(el=>{
        const file = el.getAttribute('data-include');
        fetch(file + '?v=' + ts).then(r=>r.text()).then(html=>{
          el.innerHTML = html;
          if (window.setupHeader) window.setupHeader();
        });
      });
    })();
  </script>

  <script type="module">
    import { cloudGetAll, loadLocal, saveLocal, recentWeekStarts, weekLabelFromISO, badgeHTML, downloadCSV, compressRanges } from './app.js';

    const weekSel = document.getElementById('week');
    const latest  = document.getElementById('latest');
    const result  = document.getElementById('result');
    const q       = document.getElementById('q');
    const hint    = document.getElementById('hint');

    function fillWeeks(){
      weekSel.innerHTML='';
      recentWeekStarts(12).forEach((iso,i)=>{
        const o=document.createElement('option');
        o.value=iso; o.textContent=`${weekLabelFromISO(iso)}（週一~週日）`;
        if(i===0) o.selected=true;
        weekSel.appendChild(o);
      });
    }

    function renderLatest(db){
      const items = [...db.items].sort((a,b)=>(b.updatedAt||b.createdAt||0)-(a.updatedAt||a.createdAt||0)).slice(0,9);
      latest.innerHTML = items.map(a=>`
        <article class="card">
          <img class="thumb" src="${a.image||'assets/hero.svg'}" alt="${a.name}">
          <h3 style="margin:.6rem 0 .25rem">${a.name}</h3>
          ${badgeHTML(a)}
        </article>
      `).join('') || '<p class="muted">尚未登記動畫。</p>';
    }

    function renderSearch(db, kw=''){
      kw=kw.trim().toLowerCase();
      const items = kw ? db.items.filter(a=>a.name.toLowerCase().includes(kw)) : [];
      result.innerHTML = items.map(a=>`
        <article class="card">
          <img class="thumb" src="${a.image||'assets/hero.svg'}" alt="${a.name}">
          <h3 style="margin:.6rem 0 .25rem">${a.name}</h3>
          ${badgeHTML(a)}
        </article>
      `).join('') || (kw?'<p class="muted">沒有符合的作品。</p>':'');
    }

    function rating(total){
      if(total<=5) return '極慢';
      if(total<=15) return '緩慢';
      if(total<=30) return '中等';
      if(total<=50) return '快速';
      if(total<=70) return '極快';
      if(total<=100) return '極限';
      return '混沌';
    }

    function exportWeekCSV(db, weekISO){
      const id2item = Object.fromEntries(db.items.map(a=>[a.id,a]));
      const by = new Map();
      db.logs.filter(l=>l.weekStartISO===weekISO).forEach(l=>{
        const set = by.get(l.animeId) ?? new Set();
        l.eps.forEach(e=> set.add(e)); by.set(l.animeId, set);
      });

      const rows=[]; rows.push(['動漫','集數','進度(第X集)','', '速度評價(Y集)']);
      let total=0;
      for(const [aid,set] of Array.from(by.entries()).sort((A,B)=>{
        const a=id2item[A[0]]?.name||''; const b=id2item[B[0]]?.name||''; return a.localeCompare(b,'zh-Hant');
      })){
        const eps = Array.from(set).sort((x,y)=>x-y); total+=eps.length;
        rows.push([ id2item[aid]?.name || aid, String(eps.length), compressRanges(eps).join(', ') ]);
      }
      rows.push([]); rows.push(['總計', String(total)]);
      rows[1][4] = `速度評價（${total}集）`; rows[2][4] = rating(total);

      const filename = `anime_week_${weekISO} (${weekLabelFromISO(weekISO)}).csv`;
      downloadCSV(filename, rows);
    }

    function exportAllWeeksCSV(db){
      const weeks = Array.from(new Set(db.logs.map(l=>l.weekStartISO))).sort();
      if(!weeks.length){ alert('沒有任何週次資料可匯出'); return; }
      weeks.forEach(w=> exportWeekCSV(db,w));
    }

    document.getElementById('expWeek').addEventListener('click', ()=> exportWeekCSV(loadLocal(), weekSel.value));
    document.getElementById('expAll').addEventListener('click', ()=> exportAllWeeksCSV(loadLocal()));
    document.getElementById('refresh').addEventListener('click', async ()=>{
      hint.textContent='同步中…';
      try{ const cloud=await cloudGetAll(); saveLocal(cloud); renderLatest(cloud); renderSearch(cloud, q.value); hint.textContent='同步完成'; setTimeout(()=>hint.textContent='',1200);}
      catch{ hint.textContent='同步失敗（使用本機資料）'; setTimeout(()=>hint.textContent='',2000); }
    });
    q.addEventListener('input', ()=> renderSearch(loadLocal(), q.value));

    function init(){ fillWeeks(); const db=loadLocal(); renderLatest(db); renderSearch(db,''); }
    init();
  </script>
</body>
</html>
