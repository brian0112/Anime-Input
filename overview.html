<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è§€çœ‹ç¸½è¦½</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- é ‚éƒ¨å°è¦½ -->
  <header class="site-header container">
    <a class="brand" href="index.html" aria-label="é¦–é ">ğŸ¬ å‹•ç•«é€²åº¦</a>
    <nav class="nav" aria-label="ä¸»é¸å–®">
      <a href="dashboard.html">å‹•ç•«ç´€éŒ„</a>
      <a href="manage.html">å‹•ç•«ç™»è¨˜</a>
      <a href="overview.html">è§€çœ‹ç¸½è¦½</a>
    </nav>
  </header>

  <main class="container">
    <!-- åŒ¯å‡º / é€±æ¬¡ / åŒæ­¥ -->
    <section class="section">
      <div class="row">
        <label style="margin:0">
          <span class="muted">é¸æ“‡é€±æ¬¡</span>
          <select id="week-select"></select>
        </label>
        <button id="btn-export-week" class="btn">åŒ¯å‡ºæ­¤é€± CSV</button>
        <button id="btn-export-all" class="btn">å…¨éƒ¨é€±æ¬¡å„è‡ªä¸€å¼µ CSV</button>
        <button id="btn-refresh" class="btn primary">é›²ç«¯é‡æ–°æ•´ç†</button>
        <span id="hint" class="muted"></span>
      </div>
    </section>

    <!-- æœ€æ–° 9 éƒ¨ -->
    <section class="section">
      <h2>æœ€æ–°ç™»è¨˜çš„ 9 éƒ¨ä½œå“</h2>
      <div id="latest-grid" class="grid"></div>
    </section>

    <!-- æœå°‹ -->
    <section class="section">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">æœå°‹</h2>
        <input id="q" type="search" placeholder="è¼¸å…¥å‹•ç•«åç¨±â€¦" />
      </div>
      <div id="search-grid" class="grid" style="margin-top:1rem"></div>
    </section>
  </main>

  <footer class="site-footer container">
    <small>Â© å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨</small>
  </footer>

  <script type="module">
    import { cloudGetAll, loadLocal, saveLocal, badgeHTML } from './app.js';

    // ---------- å°å·¥å…· ----------
    const pad = n => String(n).padStart(2,'0');
    function mondayOf(d=new Date()){ const x=new Date(d); const w=x.getDay()||7; if(w!==1)x.setDate(x.getDate()-(w-1)); x.setHours(0,0,0,0); return x; }
    function isoDate(d){ return d.toISOString().slice(0,10); }
    function weekLabelFromISO(iso){
      const s = new Date(iso); const e = new Date(s); e.setDate(e.getDate()+6);
      return `${s.getMonth()+1}/${pad(s.getDate())} ~ ${e.getMonth()+1}/${pad(e.getDate())}`;
    }
    function lastNWeekStarts(n=12){
      const out=[]; const base=mondayOf();
      for(let i=0;i<n;i++){ const d=new Date(base); d.setDate(base.getDate()-i*7); out.push(isoDate(d)); }
      return out;
    }
    function compressRanges(nums){
      if(!nums?.length) return [];
      const a=[...new Set(nums)].sort((x,y)=>x-y);
      const out=[]; let s=a[0],p=a[0];
      for(let i=1;i<a.length;i++){ if(a[i]===p+1){p=a[i];continue;} out.push(s===p?`${s}`:`${s}~${p}`); s=p=a[i]; }
      out.push(s===p?`${s}`:`${s}~${p}`); return out;
    }
    function rating(total){
      if(total<=5) return 'æ¥µæ…¢';
      if(total<=15) return 'ç·©æ…¢';
      if(total<=30) return 'ä¸­ç­‰';
      if(total<=50) return 'å¿«é€Ÿ';
      if(total<=70) return 'æ¥µå¿«';
      if(total<=100) return 'æ¥µé™';
      return 'æ··æ²Œ';
    }
    function downloadCSV(name, rows){
      const csv = rows.map(r=>r.map(v=>{
        const s=String(v??''); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
      }).join(',')).join('\r\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ---------- ä»‹é¢å…ƒç´  ----------
    const latestGrid = document.getElementById('latest-grid');
    const searchGrid = document.getElementById('search-grid');
    const weekSelect = document.getElementById('week-select');
    const q = document.getElementById('q');
    const hint = document.getElementById('hint');

    // ---------- Render ----------
    function renderWeekOptions(){
      weekSelect.innerHTML='';
      lastNWeekStarts(12).forEach((iso,i)=>{
        const opt=document.createElement('option'); opt.value=iso; opt.textContent=`${weekLabelFromISO(iso)}ï¼ˆé€±ä¸€~é€±æ—¥ï¼‰`;
        if(i===0) opt.selected=true; weekSelect.appendChild(opt);
      });
    }

    function renderLatest(db){
      const items = [...db.items].sort((a,b)=> (b.updatedAt||b.createdAt||0) - (a.updatedAt||a.createdAt||0)).slice(0,9);
      latestGrid.innerHTML = items.length
        ? items.map(a=>`
            <article class="card">
              <img class="thumb" src="${a.image||'assets/hero.svg'}" alt="${a.name}">
              <div>
                <h3 style="margin:.6rem 0 .25rem">${a.name}</h3>
                ${badgeHTML(a)}
              </div>
            </article>
          `).join('')
        : '<p class="muted">å°šæœªç™»è¨˜å‹•ç•«ã€‚</p>';
    }

    function renderSearch(db, kw=''){
      kw = kw.trim().toLowerCase();
      const list = kw? db.items.filter(a=>a.name.toLowerCase().includes(kw)) : [];
      searchGrid.innerHTML = list.length
        ? list.map(a=>`
            <article class="card">
              <img class="thumb" src="${a.image||'assets/hero.svg'}" alt="${a.name}">
              <div>
                <h3 style="margin:.6rem 0 .25rem">${a.name}</h3>
                ${badgeHTML(a)}
              </div>
            </article>
          `).join('')
        : (kw? '<p class="muted">æ²’æœ‰ç¬¦åˆçš„ä½œå“ã€‚</p>' : '');
    }

    async function refreshFromCloud(){
      const data = await cloudGetAll(); saveLocal(data); return data;
    }

    // ---------- åŒ¯å‡º ----------
    function exportWeekCSV(db, weekISO){
      const byAnime = new Map();
      db.logs.filter(l=>l.weekStartISO===weekISO).forEach(l=>{
        const set = byAnime.get(l.animeId) ?? new Set();
        l.eps.forEach(e=> set.add(e)); byAnime.set(l.animeId, set);
      });

      const id2item = Object.fromEntries(db.items.map(a=>[a.id,a]));
      const entries = Array.from(byAnime.entries()).sort((A,B)=>{
        const aName = id2item[A[0]]?.name || ''; const bName = id2item[B[0]]?.name || '';
        return aName.localeCompare(bName,'zh-Hant');
      });

      const rows = [];
      rows.push(['å‹•æ¼«','é›†æ•¸','é€²åº¦(ç¬¬Xé›†)','', 'é€Ÿåº¦è©•åƒ¹(Yé›†)']);
      let total = 0;

      for(const [aid, set] of entries){
        const eps = Array.from(set).sort((x,y)=>x-y);
        total += eps.length;
        rows.push([ id2item[aid]?.name || aid, String(eps.length), compressRanges(eps).join(', ') ]);
      }

      rows.push([]);                 // ç©ºè¡Œ
      rows.push(['ç¸½è¨ˆ', String(total)]); // A-n+2, B-n+2
      rows[1][4] = `é€Ÿåº¦è©•åƒ¹ï¼ˆ${total}é›†ï¼‰`; // E-1
      rows[2][4] = rating(total);        // E-2

      const filename = `anime_week_${weekISO} (${weekLabelFromISO(weekISO)}).csv`;
      downloadCSV(filename, rows);
    }

    function exportAllWeeksCSV(db){
      const weeks = Array.from(new Set(db.logs.map(l=>l.weekStartISO))).sort();
      if(!weeks.length){ alert('æ²’æœ‰ä»»ä½•é€±æ¬¡è³‡æ–™å¯åŒ¯å‡º'); return; }
      weeks.forEach(w=> exportWeekCSV(db, w));
    }

    // ---------- äº‹ä»¶ ----------
    document.getElementById('btn-export-week').addEventListener('click', ()=>{
      exportWeekCSV(loadLocal(), weekSelect.value);
    });
    document.getElementById('btn-export-all').addEventListener('click', ()=>{
      exportAllWeeksCSV(loadLocal());
    });
    document.getElementById('btn-refresh').addEventListener('click', async ()=>{
      hint.textContent='åŒæ­¥ä¸­â€¦';
      try{ const data=await refreshFromCloud(); renderLatest(data); renderSearch(data,q.value); hint.textContent='åŒæ­¥å®Œæˆ'; setTimeout(()=>hint.textContent='',1200); }
      catch(e){ console.error(e); hint.textContent='åŒæ­¥å¤±æ•—ï¼ˆä½¿ç”¨æœ¬æ©Ÿè³‡æ–™ï¼‰'; setTimeout(()=>hint.textContent='',2000); }
    });
    q.addEventListener('input', ()=> renderSearch(loadLocal(), q.value));

    // ---------- å•Ÿå‹• ----------
    renderWeekOptions();
    const db = loadLocal();
    renderLatest(db);
    renderSearch(db, '');
  </script>
</body>
</html>
