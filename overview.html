<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è§€çœ‹ç¸½è¦½</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="app.js"></script>
  <style>
    .toolbar{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .weeks-row{display:flex;gap:.5rem;flex-wrap:wrap}
    .wbadge{border:1px solid var(--border);border-radius:.5rem;padding:.15rem .45rem;font-size:.85rem}
    .wbadge[data-cnt="0"]{opacity:.6}
    .card h4{margin:.6rem 0 .3rem}
    .muted{color:var(--muted)}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header class="site-header container">
    <a href="index.html" class="brand">ğŸ¬ å‹•ç•«é€²åº¦</a>
    <nav class="nav">
      <a href="dashboard.html">å‹•ç•«ç´€éŒ„</a>
      <a href="manage.html">å‹•ç•«ç™»è¨˜</a>
      <a href="overview.html">è§€çœ‹ç¸½è¦½</a>
    </nav>
  </header>

  <main class="container section">
    <h2>è§€çœ‹ç¸½è¦½ï¼ˆå¤šé€±ï¼‰</h2>
    <div class="card toolbar">
      <label>é¡¯ç¤ºç¯„åœ
        <select id="rangeSel">
          <option value="4">æœ€è¿‘ 4 é€±</option>
          <option value="8">æœ€è¿‘ 8 é€±</option>
          <option value="12" selected>æœ€è¿‘ 12 é€±</option>
        </select>
      </label>
      <label>æœå°‹
        <input id="q" type="search" placeholder="è¼¸å…¥å‹•ç•«åç¨±â€¦">
      </label>
      <label class="row"><input type="checkbox" id="onlyActive"> åªçœ‹æœ¬æœŸæœ‰é€²åº¦</label>
      <button id="refresh" class="btn">é‡æ–°æ•´ç†</button>
      <div class="right row">
        <button id="expRange" class="btn primary">åŒ¯å‡ºæ­¤ç¯„åœï¼šæ¯é€±å„ä¸€ä»½ CSV</button>
      </div>
      <span id="hint" class="muted"></span>
    </div>

    <div id="grid" class="grid" style="margin-top:1rem"></div>
  </main>

  <footer class="site-footer container">Â© å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨</footer>

  <script type="module">
    import {
      cloudGetAll, saveLocal, loadLocal,
      recentWeekStarts, weekLabelFromISO,
      filterItemsByKeyword, badgeHTML,
      exportWeeksCSV, compressRanges
    } from './app.js';

    const rangeSel = document.getElementById('rangeSel');
    const q        = document.getElementById('q');
    const onlyAct  = document.getElementById('onlyActive');
    const refresh  = document.getElementById('refresh');
    const expRange = document.getElementById('expRange');
    const hint     = document.getElementById('hint');
    const grid     = document.getElementById('grid');

    let db = loadLocal();
    let weeks = recentWeekStarts(Number(rangeSel.value||12));

    function buildWeeks(){
      weeks = recentWeekStarts(Number(rangeSel.value||12));
    }

    function mapWeekEps(db){
      // å›å‚³ï¼šanimeId -> (weekISO -> eps[])
      const map = new Map();
      db.logs.forEach(l=>{
        const m = map.get(l.animeId) ?? new Map();
        const arr = m.get(l.weekStartISO) ?? [];
        m.set(l.weekStartISO, arr.concat(l.eps));
        map.set(l.animeId, m);
      });
      // å»é‡æ’åº
      for(const m of map.values()){
        for(const k of m.keys()){
          const arr = m.get(k);
          const set = Array.from(new Set(arr)).sort((a,b)=>a-b);
          m.set(k, set);
        }
      }
      return map;
    }

    function render(){
      const kw = q.value||'';
      const idWeekMap = mapWeekEps(db);
      const showItems = filterItemsByKeyword(db.items, kw)
        .sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));

      const cards = [];
      for(const a of showItems){
        const wm = idWeekMap.get(a.id) || new Map();

        // æœ¬æœŸæ˜¯å¦æœ‰é€²åº¦
        const totalThisRange = weeks.reduce((s,w)=> s + ((wm.get(w)||[]).length), 0);
        if(onlyAct.checked && totalThisRange===0) continue;

        const weeksHtml = weeks.map(w=>{
          const eps = wm.get(w) || [];
          const tip = eps.length ? `æœ¬é€± ${eps.length} é›†ï¼š${compressRanges(eps).join(', ')}` : `æœ¬é€± 0 é›†`;
          return `<span class="wbadge" data-cnt="${eps.length}" title="${tip}">${weekLabelFromISO(w)}ï¼š${eps.length} é›†</span>`;
        }).join('');

        cards.push(`
          <article class="card">
            <h4>${a.name}</h4>
            ${badgeHTML(a.watched?.length||0, a.episodes||0)}
            <div class="weeks-row" style="margin-top:.5rem">${weeksHtml}</div>
          </article>
        `);
      }

      grid.innerHTML = cards.join('') || `<p class="muted">æ­¤ç¯„åœå…§æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä½œå“ã€‚</p>`;
    }

    async function syncCloud(){
      hint.textContent='åŒæ­¥ä¸­â€¦';
      try{
        const fresh = await cloudGetAll();
        db = fresh; saveLocal(fresh);
        hint.textContent='å·²åŒæ­¥';
      }catch(e){
        hint.textContent='åŒæ­¥å¤±æ•—ï¼ˆä½¿ç”¨æœ¬æ©Ÿè³‡æ–™ï¼‰';
        console.warn(e);
      }finally{
        setTimeout(()=>hint.textContent='',1500);
      }
      render();
    }

    rangeSel.addEventListener('change', ()=>{ buildWeeks(); render(); });
    q.addEventListener('input', render);
    onlyAct.addEventListener('change', render);
    refresh.addEventListener('click', syncCloud);
    expRange.addEventListener('click', ()=> exportWeeksCSV(db, weeks));

    // åˆå§‹
    buildWeeks(); render(); // å…ˆç”¨æœ¬æ©Ÿ
    syncCloud();           // å†æ‹‰é›²ç«¯
  </script>
</body>
</html>
