<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å‹•ç•«ç™»è¨˜ / ç®¡ç†</title>
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css" />
  <style>
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap}
    .pill{border:1px solid var(--border);padding:.25rem .6rem;border-radius:999px;color:var(--muted);text-decoration:none}
    :root{ --danger:#ef4444; --danger-ink:#ffffff; }
    .manage-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
    .manage-card{display:grid;grid-template-columns:1.3fr 1fr;gap:1rem;border:1px solid var(--border);background:var(--panel);border-radius:1rem;padding:1rem;position:relative}
    .thumb{aspect-ratio:16/9;width:100%;object-fit:cover;border-radius:.75rem;border:1px solid var(--border)}
    .right{display:grid;gap:.5rem;padding-right:2.4rem}
    .title-row{display:flex;justify-content:space-between;gap:.75rem;align-items:flex-start}
    .badge{font-size:.8rem;padding:.2rem .5rem;border-radius:.5rem;border:1px solid var(--border)}
    .badge.complete{background:var(--brand);color:var(--brand-ink);border-color:transparent;font-weight:700}
    .icon-btn{position:absolute;top:.6rem;right:.6rem;border:1px solid transparent;background:var(--danger);color:var(--danger-ink);border-radius:.6rem;padding:.45rem;cursor:pointer;z-index:2;box-shadow:0 4px 14px rgba(239,68,68,.35)}
    .icon-btn:hover{filter:brightness(1.1)}
    .icon-trash{width:18px;height:18px;display:block}
    @media (max-width: 1024px){ .manage-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header class="site-header container">
    <a class="brand" href="index.html" aria-label="é¦–é ">ğŸï¸ å‹•ç•«é€²åº¦</a>
    <nav class="nav tabs" aria-label="ä¸»é¸å–®">
      <a class="pill" href="index.html">å‹•ç•«ç´€éŒ„</a>
      <a class="pill" href="manage.html">å‹•ç•«ç™»è¨˜</a>
      <a class="pill" href="dashboard.html">è§€çœ‹ç¸½è¦½</a>
      <button id="themeToggle" class="btn outline" aria-pressed="false" aria-label="åˆ‡æ›æ·±æ·ºè‰²" style="margin-left:auto">ä¸»é¡Œ</button>
    </nav>
  </header>

  <main class="container section">
    <h2>å‹•ç•«ç™»è¨˜ / ç®¡ç†</h2>

    <div class="row" style="display:flex;gap:.75rem;align-items:center">
      <button id="open-create" class="btn primary">æ–°å¢å‹•ç•«</button>
      <span class="muted">æ–°å¢å¾Œæœƒå‡ºç¾åœ¨ã€Œå‹•ç•«ç´€éŒ„ã€èˆ‡ã€Œè§€çœ‹ç¸½è¦½ã€ã€‚</span>
    </div>

    <div class="section card" style="display:grid;gap:1rem;margin-top:1rem">
      <h3>å·²ç™»è¨˜å‹•ç•«</h3>
      <div id="manage-list" class="manage-grid"></div>
    </div>

    <dialog id="create-dialog">
      <form class="stack" id="create-form" method="dialog" style="display:grid;gap:.8rem;max-width:560px">
        <h3>æ–°å¢å‹•ç•«</h3>
        <label>å‹•ç•«åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰<input id="create-image" type="file" accept="image/*"></label>
        <label>å‹•ç•«åç¨±<input id="create-name" type="text" placeholder="ä¾‹å¦‚ï¼šæ˜Ÿéš›æ¼‚æµè¨˜" required></label>
        <label>å‹•ç•«é›†æ•¸<input id="create-episodes" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹å¦‚ï¼š12" required></label>
        <div class="row" style="display:flex;gap:.75rem;align-items:center">
          <button class="btn primary" id="create-submit" type="button">å„²å­˜</button>
          <button class="btn" id="create-cancel" type="button">å–æ¶ˆ</button>
          <span id="create-msg" class="muted" aria-live="polite"></span>
        </div>
      </form>
    </dialog>
  </main>

  <footer class="site-footer container">
    <small>&copy; <span id="year"></span> å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨</small>
  </footer>

  <script type="module">
    import {
      API_URL, bootstrap, loadLocal, saveLocal, cloudEnabled,
      cloudGetAll, cloudAddAnime, cloudDeleteAnime, uid, badgeHTML
    } from './app.js';

    document.getElementById('year').textContent = new Date().getFullYear();

    const openCreateBtn = document.getElementById('open-create');
    const createDialog  = document.getElementById('create-dialog');
    const createForm    = document.getElementById('create-form');
    const createImage   = document.getElementById('create-image');
    const createName    = document.getElementById('create-name');
    const createEps     = document.getElementById('create-episodes');
    const createSubmit  = document.getElementById('create-submit');
    const createCancel  = document.getElementById('create-cancel');
    const createMsg     = document.getElementById('create-msg');
    const manageList    = document.getElementById('manage-list');

    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
      });
    }

    function render(){
      const db = loadLocal();
      manageList.innerHTML = '';
      if(db.items.length===0){
        manageList.innerHTML = '<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>'; return;
      }
      const items = db.items.slice().sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'));
      for(const a of items){
        const card = document.createElement('article');
        card.className = 'manage-card';
        card.innerHTML = `
          <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
          <div class="right">
            <div class="title-row">
              <strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${a.name}">${a.name}</strong>
              ${badgeHTML(a)}
            </div>
            <small class="muted">å…± ${a.episodes} é›† Â· å·²çœ‹ ${a.watched?.length||0} é›†</small>
          </div>
          <button class="icon-btn" title="åˆªé™¤" aria-label="åˆªé™¤">
            <svg class="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
              <path d="M10 11v6"></path>
              <path d="M14 11v6"></path>
              <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        `;
        card.querySelector('.icon-btn').addEventListener('click', async ()=>{
          if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${a.name}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
          const db2 = loadLocal();
          const idx = db2.items.findIndex(x=>x.id===a.id);
          if(idx>-1) db2.items.splice(idx,1);
          db2.logs = (db2.logs||[]).filter(l=> l.animeId!==a.id);
          saveLocal(db2);
          try{
            await cloudDeleteAnime(a.id);
            const latest = await cloudGetAll();
            saveLocal(latest);
            render();
          }catch(err){
            alert('é›²ç«¯åˆªé™¤å¤±æ•—ï¼Œä½†æœ¬æ©Ÿå·²åˆªé™¤ã€‚è«‹ç¨å¾Œå†åŒæ­¥ã€‚');
            console.error(err); render();
          }
        });
        manageList.appendChild(card);
      }
    }

    openCreateBtn.addEventListener('click', ()=>{ createForm.reset(); createMsg.textContent=''; createDialog.showModal(); });
    createCancel.addEventListener('click', ()=> createDialog.close());
    createDialog.addEventListener('cancel', (e)=>{ e.preventDefault(); createDialog.close(); });

    // âœ… ä¿®æ­£ï¼šå„²å­˜æŒ‰éˆ•ä¸€å®šé€å‡ºï¼ˆå…ˆæœ¬æ©Ÿã€å†é›²ç«¯ï¼ŒæˆåŠŸå¾Œé—œé–‰èˆ‡åˆ·æ–°ï¼‰
    createSubmit.addEventListener('click', async ()=>{
      createMsg.textContent = '';
      const name = createName.value.trim();
      const epsStr = createEps.value.trim();
      if(!name){ createMsg.textContent='è«‹è¼¸å…¥åç¨±'; return; }
      if(!/^[0-9]+$/.test(epsStr)){ createMsg.textContent='é›†æ•¸åƒ…èƒ½è¼¸å…¥æ•¸å­—'; return; }
      const episodes = Math.max(1, parseInt(epsStr,10));
      let imageData = null; const file = createImage.files?.[0]; if(file){ imageData = await fileToDataURL(file); }

      // æœ¬æ©Ÿ
      const db = loadLocal();
      if(db.items.some(x=> x.name===name)){ createMsg.textContent='æ­¤åç¨±å·²å­˜åœ¨ï¼Œè‹¥è¦é‡æ–°ä¸Šå‚³è«‹å…ˆåˆªé™¤èˆŠè³‡æ–™ã€‚'; return; }
      const id = uid();
      db.items.push({ id, name, episodes, image:imageData||undefined, createdAt:Date.now(), updatedAt:Date.now(), watched:[] });
      saveLocal(db);

      try{
        await cloudAddAnime({ id, name, episodes, image:imageData||'', createdAt:Date.now(), updatedAt:Date.now() });
        const latest = await cloudGetAll(); saveLocal(latest);
        createDialog.close(); render();
      }catch(err){
        createMsg.textContent = 'é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œä½†æœ¬æ©Ÿå·²æ–°å¢ï¼ˆå¯ç¨å¾Œå†è©¦ï¼‰ã€‚';
        console.error(err);
      }
    });

    await bootstrap();
    render();
  </script>
  <script src="script.js" defer></script>
</body>
</html>
