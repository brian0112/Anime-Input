<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>動畫登記</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div data-include="header.html"></div>
  <main>
    <button id="open-create">➕ 新增動畫</button>
    <div id="list"></div>

    <dialog id="create-dialog">
      <form method="dialog">
        <h3>新增動畫</h3>
        <input id="anime-name" placeholder="名稱" required>
        <input id="anime-episodes" type="number" placeholder="集數" required>
        <input id="anime-image" placeholder="封面圖片URL">
        <menu>
          <button value="cancel">取消</button>
          <button id="btn-save">儲存</button>
        </menu>
      </form>
    </dialog>
  </main>

  <footer>
    <small>© 動畫進度 · 由你打造 ✨</small>
  </footer>

  <script type="module">
    import { uid, loadLocal, saveLocal, cloudAddAnime, cloudDeleteAnime, cloudGetAll } from './app.js';

    const list = document.getElementById('list');
    const dialog = document.getElementById('create-dialog');
    const btnOpen = document.getElementById('open-create');
    const btnSave = document.getElementById('btn-save');

    btnOpen.addEventListener('click', () => dialog.showModal());
    btnSave.addEventListener('click', async (e) => {
      e.preventDefault();
      const name = document.getElementById('anime-name').value.trim();
      const episodes = Number(document.getElementById('anime-episodes').value);
      const image = document.getElementById('anime-image').value.trim();

      if (!name || !episodes) return alert('請輸入完整資料');

      const a = { id: uid(), name, episodes, image, createdAt: Date.now(), updatedAt: Date.now() };

      try {
        await cloudAddAnime(a);
        const db = loadLocal();
        db.items.push(a);
        saveLocal(db);
        alert('✅ 新增成功');
        dialog.close();
        renderList();
      } catch (err) {
        console.error(err);
        alert('❌ 雲端同步失敗');
      }
    });

    async function renderList() {
      const db = loadLocal();
      if (!db.items.length) {
        list.innerHTML = '<p>目前沒有登記的動畫。</p>';
      } else {
        list.innerHTML = db.items.map(a => `
          <div class="anime-row">
            <img src="${a.image}" alt="">
            <span>${a.name}（${a.episodes}集）</span>
            <button data-id="${a.id}" class="del">刪除</button>
          </div>
        `).join('');

        list.querySelectorAll('.del').forEach(btn => btn.addEventListener('click', async (ev) => {
          const id = ev.target.dataset.id;
          if (!confirm('確定要刪除此動畫嗎？')) return;
          await cloudDeleteAnime(id);
          const db = loadLocal();
          db.items = db.items.filter(x => x.id !== id);
          saveLocal(db);
          renderList();
        }));
      }
    }

    renderList();
  </script>
  <script>
  // 自動載入共用 header（含 cache-busting）
  (function loadSharedPart(){
    const ts = (window.__BUILD_TS || Date.now()); // 版本號/時間戳
    document.querySelectorAll('[data-include]').forEach(el=>{
      const file = el.getAttribute('data-include');
      const url = file + '?v=' + ts;
      fetch(url).then(r=>r.text()).then(html=>{
        el.innerHTML = html;
        // 載入完成後（header 已插入 DOM），呼叫全域初始化（若有）
        if (window.setupHeader) window.setupHeader();
      }).catch(err=>{
        console.error('無法載入共用檔案：', file, err);
      });
    });
  })();
</script>
</body>
</html>
