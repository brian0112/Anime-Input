<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å‹•ç•«ç´€éŒ„</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="app.js"></script>
  <style>
    .record-panel{display:grid;gap:1rem}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--border);padding:.3rem .6rem;border-radius:999px}
    .pill button{margin-left:.5rem}
    .muted{color:var(--muted)}
    .notice{color:#ef4444;font-weight:600}
  </style>
</head>
<body>
<header class="site-header container">
  <a href="index.html" class="brand">ğŸ¬ å‹•ç•«é€²åº¦</a>
  <nav class="nav">
    <a href="dashboard.html">å‹•ç•«ç´€éŒ„</a>
    <a href="manage.html">å‹•ç•«ç™»è¨˜</a>
    <a href="overview.html">è§€çœ‹ç¸½è¦½</a>
  </nav>
  <button id="themeToggle" class="btn outline">ä¸»é¡Œ</button>
</header>

<main class="container section">
  <h2>è¼¸å…¥ã€Œå‹•ç•«ç´€éŒ„ã€</h2>

  <div class="card record-panel">
    <div class="row">
      <label style="min-width:240px">å‹•ç•«
        <select id="animeSelect"></select>
      </label>

      <label style="min-width:220px">é€±æ¬¡ï¼ˆå°åŒ— / é€±ä¸€~é€±æ—¥ï¼‰
        <select id="weekSelect"></select>
      </label>
    </div>

    <div class="row">
      <strong>é›†æ•¸ï¼ˆå€é–“ï¼‰</strong>
      <input id="rangeStart" type="number" min="1" step="1" style="width:6rem" placeholder="èµ·å§‹">
      <span>~</span>
      <input id="rangeEnd"   type="number" min="1" step="1" style="width:6rem" placeholder="çµæŸ">
      <button id="addRangeBtn" class="btn">åŠ å…¥</button>
      <button id="clearRangeBtn" class="btn outline">æ¸…ç©º</button>
    </div>

    <div id="pendingArea" class="row"></div>
    <p id="hint" class="muted"></p>
    <p id="warn" class="notice"></p>

    <div class="row">
      <button id="saveBtn" class="btn primary">å„²å­˜æœ¬é€±ç´€éŒ„</button>
      <span id="status" class="muted" aria-live="polite"></span>
    </div>
  </div>
</main>

<footer class="site-footer container">
  Â© å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨
</footer>

<script type="module">
  import {
    loadLocal, saveLocal,
    cloudGetAll, cloudAddLog,
    recentWeekStarts, weekLabelFromISO,
    nextUnwatched, expandRange, findDupEpisodes, clamp
  } from './app.js';

  const animeSel   = document.getElementById('animeSelect');
  const weekSel    = document.getElementById('weekSelect');
  const sInput     = document.getElementById('rangeStart');
  const eInput     = document.getElementById('rangeEnd');
  const addBtn     = document.getElementById('addRangeBtn');
  const clearBtn   = document.getElementById('clearRangeBtn');
  const pendingBox = document.getElementById('pendingArea');
  const saveBtn    = document.getElementById('saveBtn');
  const hint       = document.getElementById('hint');
  const warn       = document.getElementById('warn');
  const status     = document.getElementById('status');

  let db = loadLocal();
  let pending = new Set();  // æ±‡æ•´å°‡è¦ä¸Šå‚³çš„é›†æ•¸ï¼ˆå¯å¤šå€‹å€é–“åŠ å…¥ï¼‰

  async function boot(){
    try{
      const fresh = await cloudGetAll();
      db = fresh; saveLocal(fresh);
    }catch(e){
      console.warn('é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨å¿«å–', e);
    }
    buildUI();
  }

  function buildUI(){
    // å‹•ç•«é¸å–®ï¼ˆæœ€æ–°æ›´æ–°å„ªå…ˆï¼‰
    const items = [...db.items].sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
    animeSel.innerHTML = items.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');

    // é€±æ¬¡ï¼ˆå°åŒ— / é€±ä¸€~é€±æ—¥ï¼‰
    const weeks = recentWeekStarts(12);
    weekSel.innerHTML = weeks
      .map((iso,i)=>`<option value="${iso}" ${i===0?'selected':''}>${weekLabelFromISO(iso)}</option>`)
      .join('');

    animeSel.onchange = onAnimeChange;
    weekSel.onchange  = () => {}; // ä¿ç•™æ›å‹¾ï¼ˆè‹¥éœ€é€±æ¬¡è®Šæ›´æ™‚é‚è¼¯ï¼‰
    addBtn.onclick    = onAddRange;
    clearBtn.onclick  = () => { pending.clear(); renderPending(); };
    saveBtn.onclick   = onSave;

    onAnimeChange();
  }

  function currentAnime(){
    const id = animeSel.value;
    return db.items.find(a => a.id === id);
  }

  function onAnimeChange(){
    pending.clear();
    warn.textContent = '';
    const a = currentAnime();
    if(!a){ hint.textContent = 'å°šç„¡å‹•ç•«è³‡æ–™ã€‚'; return; }

    // è¼¸å…¥ä¸Šä¸‹é™é™åˆ¶ + é è¨­å€¼
    sInput.min = eInput.min = 1;
    sInput.max = eInput.max = a.episodes || 1;

    const start = nextUnwatched(a);
    sInput.value = String(start);
    eInput.value = String(start);

    const watchedCount = (a.watched||[]).length;
    hint.textContent = `å…± ${a.episodes} é›†ï¼Œå·²çœ‹ ${watchedCount} é›†ã€‚`;

    renderPending();
  }

  function renderPending(){
    // é¡¯ç¤ºç›®å‰å·²åŠ å…¥çš„å¤šå€‹å€é–“/é›†æ•¸
    const list = Array.from(pending).sort((x,y)=>x-y);
    pendingBox.innerHTML = '';
    if(list.length === 0){
      pendingBox.innerHTML = '<span class="muted">å°šæœªåŠ å…¥ä»»ä½•é›†æ•¸</span>';
      return;
    }
    // è½‰æˆç°¡æ½”çš„ç¯„åœé¡¯ç¤º
    const ranges = compaction(list);
    for(const [s,e] of ranges){
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = (s===e ? `Ep ${s}` : `Ep ${s} ~ ${e}`);
      const del = document.createElement('button');
      del.className = 'btn outline';
      del.textContent = 'ç§»é™¤';
      del.onclick = ()=>{
        for(let i=s;i<=e;i++) pending.delete(i);
        renderPending();
      };
      pill.appendChild(del);
      pendingBox.appendChild(pill);
    }
  }

  // å°‡å·²æ’åºé›†æ•¸å£“æˆ [start,end] åˆ—è¡¨
  function compaction(sortedNums){
    if(sortedNums.length===0) return [];
    const out = [];
    let s = sortedNums[0], p = sortedNums[0];
    for(let i=1;i<sortedNums.length;i++){
      const v = sortedNums[i];
      if(v === p+1){ p=v; continue; }
      out.push([s,p]); s=p=v;
    }
    out.push([s,p]);
    return out;
  }

  function onAddRange(){
    warn.textContent = ''; status.textContent = '';
    const a = currentAnime();
    if(!a) return;

    const max = a.episodes || 1;
    let s = clamp(Number(sInput.value||1), 1, max);
    let e = clamp(Number(eInput.value||1), 1, max);
    sInput.value = String(s); eInput.value = String(e);

    const toAdd = expandRange(s, e);
    if(toAdd.length===0){ warn.textContent = 'è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸å­—å€é–“'; return; }

    // æª¢æŸ¥æ˜¯å¦èˆ‡å·²çœ‹éé‡ç–Š
    const dups = findDupEpisodes(a, toAdd);
    if(dups.length){
      warn.textContent = `ä»¥ä¸‹é›†æ•¸å·²è¨˜éŒ„éï¼š${dups.join(', ')}ï¼Œä¸æœƒåŠ å…¥ã€‚`;
      return; // ç›´æ¥é˜»æ“‹
    }

    toAdd.forEach(n => pending.add(n));
    renderPending();
  }

  async function onSave(){
    warn.textContent = ''; status.textContent = '';
    const a = currentAnime();
    if(!a){ warn.textContent='æ²’æœ‰å¯å„²å­˜çš„å‹•ç•«'; return; }
    const weekISO = weekSel.value;
    const eps = Array.from(pending).sort((x,y)=>x-y);
    if(eps.length===0){ warn.textContent='è«‹å…ˆåŠ å…¥è‡³å°‘ä¸€å€‹é›†æ•¸'; return; }

    // å†æ¬¡æª¢æŸ¥é‡è¤‡ï¼ˆä¿éšªï¼‰
    const dups = findDupEpisodes(a, eps);
    if(dups.length){
      warn.textContent = `ä»¥ä¸‹é›†æ•¸å·²è¨˜éŒ„éï¼š${dups.join(', ')}ï¼Œä¸æœƒä¸Šå‚³ã€‚`;
      return;
    }

    status.textContent = 'ä¸Šå‚³ä¸­â€¦';
    try{
      await cloudAddLog(a.id, weekISO, eps);
      status.textContent = 'âœ… å·²å„²å­˜ï¼';

      // é‡æ–°æŠ“ä¸€æ¬¡é›²ç«¯ï¼Œæ›´æ–°å¿«å–èˆ‡ UI
      const fresh = await cloudGetAll();
      db = fresh; saveLocal(fresh);
      pending.clear();
      onAnimeChange();
    }catch(e){
      console.error(e);
      status.textContent = 'âŒ é›²ç«¯åŒæ­¥å¤±æ•—ï¼ˆç¨å¾Œå†è©¦ï¼‰';
    }
  }

  boot();
</script>
</body>
</html>
