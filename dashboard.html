<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è§€çœ‹ç¸½è¦½ / æœå°‹ / åŒ¯å‡º</title>
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css" />
  <style>
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap}
    .pill{border:1px solid var(--border);padding:.25rem .6rem;border-radius:999px;color:var(--muted);text-decoration:none}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
    @media (max-width: 1024px){ .grid-3{grid-template-columns:1fr} }
    .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:.75rem;border:1px solid var(--border)}
    .badge{font-size:.8rem;padding:.2rem .5rem;border-radius:.5rem;border:1px solid var(--border)}
    .badge.complete{background:var(--brand);color:var(--brand-ink);border-color:transparent;font-weight:700}
  </style>
</head>
<body>
  <header class="site-header container">
    <a class="brand" href="index.html" aria-label="é¦–é ">ğŸï¸ å‹•ç•«é€²åº¦</a>
    <nav class="nav tabs" aria-label="ä¸»é¸å–®">
      <a class="pill" href="index.html">å‹•ç•«ç´€éŒ„</a>
      <a class="pill" href="manage.html">å‹•ç•«ç™»è¨˜</a>
      <a class="pill" href="dashboard.html">è§€çœ‹ç¸½è¦½</a>
      <button id="themeToggle" class="btn outline" aria-pressed="false" aria-label="åˆ‡æ›æ·±æ·ºè‰²" style="margin-left:auto">ä¸»é¡Œ</button>
    </nav>
  </header>

  <main class="container section">
    <h2>è§€çœ‹ç¸½è¦½ / æœå°‹ / åŒ¯å‡º</h2>

    <div class="row" style="display:flex;gap:.5rem;flex-wrap:wrap">
      <button id="export-csv-week" class="btn outline">åŒ¯å‡ºæœ¬é€±ï¼ˆCSVï¼‰</button>
      <button id="export-csv-all" class="btn outline">åŒ¯å‡ºå…¨éƒ¨é€±æ¬¡ï¼ˆå¤šæª” CSVï¼‰</button>
    </div>

    <div class="section">
      <h3>æœ€æ–°ç™»è¨˜çš„ 9 éƒ¨ä½œå“</h3>
      <div id="latest-grid" class="grid-3"></div>
    </div>

    <div class="section card">
      <h3>æœå°‹å…¶ä»–ä½œå“</h3>
      <div class="row" style="display:flex;gap:.5rem">
        <input id="search-input" type="search" placeholder="è¼¸å…¥é—œéµå­—..." />
        <button id="search-clear" class="btn">æ¸…é™¤</button>
      </div>
      <div id="search-results" class="grid-3" style="margin-top:1rem"></div>
    </div>
  </main>

  <footer class="site-footer container">
    <small>&copy; <span id="year"></span> å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨</small>
  </footer>

  <script type="module">
    import {
      bootstrap, loadLocal, saveLocal, cloudGetAll,
      badgeHTML, csvEscape, compressToRanges, formatWeekRangeFromISO, downloadText
    } from './app.js';

    document.getElementById('year').textContent = new Date().getFullYear();

    const latestGrid    = document.getElementById('latest-grid');
    const searchInput   = document.getElementById('search-input');
    const searchClear   = document.getElementById('search-clear');
    const searchResults = document.getElementById('search-results');
    const exportWeekBtn = document.getElementById('export-csv-week');
    const exportAllBtn  = document.getElementById('export-csv-all');

    function render(){
      const db = loadLocal();
      renderLatest(db);
      renderSearch(db, searchInput.value?.trim()||'');
    }

    function renderLatest(db){
      latestGrid.innerHTML='';
      if(db.items.length===0){ latestGrid.innerHTML='<div class="muted">å°šæœªç™»è¨˜ä»»ä½•å‹•ç•«ã€‚</div>'; return; }
      const top9 = db.items.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0,9);
      for(const a of top9){
        const el = document.createElement('article');
        el.className = 'card';
        el.style.display='grid'; el.style.gap='.5rem';
        el.innerHTML = `
          <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${a.name}">${a.name}</strong>
            ${badgeHTML(a)}
          </div>
        `;
        latestGrid.appendChild(el);
      }
    }

    function renderSearch(db, kw){
      searchResults.innerHTML='';
      if(!kw) return;
      const list = db.items.slice().filter(a => a.name.toLowerCase().includes(kw.toLowerCase()));
      if(list.length===0){ searchResults.innerHTML='<div class="muted">æ²’æœ‰ç¬¦åˆçš„ä½œå“ã€‚</div>'; return; }
      for(const a of list){
        const el = document.createElement('article');
        el.className = 'card';
        el.style.display='grid'; el.style.gap='.5rem';
        el.innerHTML = `
          <img class="thumb" alt="${a.name}" src="${a.image || 'assets/hero.svg'}">
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${a.name}">${a.name}</strong>
            ${badgeHTML(a)}
          </div>
        `;
        searchResults.appendChild(el);
      }
    }
    searchInput.addEventListener('input', ()=> renderSearch(loadLocal(), searchInput.value));
    searchClear.addEventListener('click', ()=>{ searchInput.value=''; renderSearch(loadLocal(), ''); });

    // é€Ÿåº¦è©•åƒ¹
    function speedLabel(total){
      if(total<=5) return 'æ¥µæ…¢';
      if(total<=15) return 'ç·©æ…¢';
      if(total<=30) return 'ä¸­ç­‰';
      if(total<=50) return 'å¿«é€Ÿ';
      if(total<=70) return 'æ¥µå¿«';
      if(total<=100) return 'æ¥µé™';
      if(total<=200) return 'æ··æ²Œ';
      return 'æ··æ²Œ';
    }

    function exportWeekCSV(weekStartISO){
      const db = loadLocal();
      const rows = [['å‹•æ¼«','é›†æ•¸','é€²åº¦(ç¬¬Xé›†)','', 'é€Ÿåº¦è©•åƒ¹(0é›†)']]; // E-1 çš„ Y æœƒæ”¹æˆç¸½é›†æ•¸
      const logs = db.logs.filter(l => l.weekStartISO === weekStartISO);

      const byAnime = new Map();
      for(const l of logs){
        const eps = byAnime.get(l.animeId) || new Set();
        (l.eps||[]).forEach(x=> eps.add(x));
        byAnime.set(l.animeId, eps);
      }
      let sum = 0;
      for(const [animeId, epsSet] of byAnime.entries()){
        const a = db.items.find(x=> x.id===animeId);
        const eps = Array.from(epsSet).sort((x,y)=>x-y);
        const ranges = compressToRanges(eps);
        const count = eps.length;
        rows.push([ a?.name ?? animeId, String(count), ranges.join(','), '', `ï¼ˆ${count}é›†ï¼‰` ]);
        sum += count;
      }
      rows.push(['ç¸½è¨ˆ', String(sum)]);               // A-n+2 / B-n+2
      rows[0][4] = `é€Ÿåº¦è©•åƒ¹(${sum}é›†)`;             // E-1 é¡¯ç¤ºæœ¬é€±ç¸½é›†æ•¸
      if(rows.length>=3){ rows[1][4] = speedLabel(sum); } // E-2 æ”¾è©•åƒ¹

      const csv = rows.map(r=> r.map(csvEscape).join(',')).join('\r\n');
      const filename = `anime_watch_${formatWeekRangeFromISO(weekStartISO).replace(/[^\d~â€“]/g,'').replace('â€“','-')}.csv`;
      downloadText(csv, filename);
    }
    function exportAllWeeksCSV(){
      const db = loadLocal();
      const weeks = Array.from(new Set(db.logs.map(l=> l.weekStartISO))).sort();
      for(const w of weeks){ exportWeekCSV(w); }
    }

    // åŒ¯å‡ºæŒ‰éˆ•ï¼ˆæœ¬é ä»¥ã€Œæœ€æ–°é€±ã€ç‚ºä¸»ï¼‰
    exportWeekBtn.addEventListener('click', ()=>{
      const weeks = Array.from(new Set(loadLocal().logs.map(l=> l.weekStartISO))).sort();
      const last = weeks[weeks.length-1] || null;
      const use = last || (new Date(), new Date()); // æ²’è³‡æ–™å°±ç”¨æœ¬é€±
      exportWeekCSV(last || new Date().toISOString());
    });
    exportAllBtn.addEventListener('click', ()=> exportAllWeeksCSV());

    await bootstrap();
    // æ‹‰ä¸€æ¬¡é›²ç«¯æœ€æ–°
    try{ const latest = await cloudGetAll(); saveLocal(latest); }catch(_){}
    render();
  </script>
  <script src="script.js" defer></script>
</body>
</html>
