<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å‹•ç•«ç´€éŒ„</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="app.js"></script>
  <style>
    .record{display:grid;gap:1rem}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--border);padding:.25rem .6rem;border-radius:999px}
    .pill button{margin-left:.5rem}
    .notice{color:#ef4444;font-weight:600}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header container">
    <a href="index.html" class="brand">ğŸ¬ å‹•ç•«é€²åº¦</a>
    <nav class="nav">
      <a href="dashboard.html">å‹•ç•«ç´€éŒ„</a>
      <a href="manage.html">å‹•ç•«ç™»è¨˜</a>
      <a href="overview.html">è§€çœ‹ç¸½è¦½</a>
    </nav>
  </header>

  <main class="container section">
    <h2>è¼¸å…¥ã€Œå‹•ç•«ç´€éŒ„ã€</h2>

    <div class="card record">
      <div class="row">
        <label>å‹•ç•«
          <select id="anime"></select>
        </label>
        <label>é€±æ¬¡ï¼ˆå°åŒ—é€±ä¸€~é€±æ—¥ï¼‰
          <select id="week"></select>
        </label>
      </div>

      <div class="row">
        <strong>é›†æ•¸å€é–“</strong>
        <input id="s" type="number" min="1" step="1" style="width:6rem" placeholder="èµ·">
        <span>~</span>
        <input id="e" type="number" min="1" step="1" style="width:6rem" placeholder="è¿„">
        <button id="add" class="btn">åŠ å…¥</button>
        <button id="clear" class="btn outline">æ¸…ç©º</button>
      </div>

      <div id="pending" class="row"><span class="muted">å°šæœªåŠ å…¥ä»»ä½•é›†æ•¸</span></div>
      <p id="warn" class="notice"></p>
      <div class="row">
        <button id="save" class="btn primary">å„²å­˜æœ¬é€±ç´€éŒ„</button>
        <span id="status" class="muted" aria-live="polite"></span>
      </div>
    </div>
  </main>

  <footer class="site-footer container">Â© å‹•ç•«é€²åº¦ Â· ç”±ä½ æ‰“é€  âœ¨</footer>

  <script type="module">
    import {
      cloudGetAll, cloudAddLog, saveLocal, loadLocal,
      recentWeekStarts, weekLabelFromISO,
      clamp, uniq
    } from './app.js';

    const el = {
      anime: document.getElementById('anime'),
      week : document.getElementById('week'),
      s    : document.getElementById('s'),
      e    : document.getElementById('e'),
      add  : document.getElementById('add'),
      clr  : document.getElementById('clear'),
      pend : document.getElementById('pending'),
      save : document.getElementById('save'),
      warn : document.getElementById('warn'),
      stat : document.getElementById('status')
    };

    let db = loadLocal();
    let pending = new Set();

    function compressList(sorted){
      if(!sorted.length) return [];
      const out=[]; let s=sorted[0], p=sorted[0];
      for(let i=1;i<sorted.length;i++){
        const v=sorted[i];
        if(v===p+1){ p=v; continue; }
        out.push([s,p]); s=p=v;
      }
      out.push([s,p]); return out;
    }

    function renderPending(){
      const list = Array.from(pending).sort((a,b)=>a-b);
      if(!list.length){ el.pend.innerHTML='<span class="muted">å°šæœªåŠ å…¥ä»»ä½•é›†æ•¸</span>'; return; }
      const ranges = compressList(list);
      el.pend.innerHTML = ranges.map(([s,e])=>{
        return `<span class="pill">Ep ${s===e? s : `${s} ~ ${e}`} <button class="btn outline" data-del="${s}-${e}">ç§»é™¤</button></span>`;
      }).join(' ');
      el.pend.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = ()=>{
          const [s,e] = btn.dataset.del.split('-').map(Number);
          for(let i=s;i<=e;i++) pending.delete(i);
          renderPending();
        };
      });
    }

    function currentAnime(){
      const id = el.anime.value;
      return db.items.find(a=>a.id===id);
    }

    function buildWeeks(){
      const weeks = recentWeekStarts(12);
      el.week.innerHTML = weeks.map((iso,i)=>
        `<option value="${iso}" ${i===0?'selected':''}>${weekLabelFromISO(iso)}</option>`
      ).join('');
    }

    function buildAnimes(){
      const items = [...db.items].sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
      el.anime.innerHTML = items.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
      onAnimeChange();
    }

    function onAnimeChange(){
      pending.clear(); renderPending(); el.warn.textContent=''; el.stat.textContent='';
      const a = currentAnime(); if(!a) return;
      el.s.min = el.e.min = 1;
      el.s.max = el.e.max = a.episodes||1;
      // é è¨­å¾ä¸‹ä¸€æœªè§€çœ‹é–‹å§‹
      const set = new Set(a.watched||[]);
      let start = 1; for(let i=1;i<= (a.episodes||1); i++){ if(!set.has(i)){ start=i; break; } }
      el.s.value = String(start); el.e.value = String(start);
    }

    function addRange(){
      el.warn.textContent=''; el.stat.textContent='';
      const a = currentAnime(); if(!a){ el.warn.textContent='å°šç„¡å‹•ç•«'; return; }
      const max = a.episodes||1;
      let s = clamp(Number(el.s.value||1), 1, max);
      let e = clamp(Number(el.e.value||1), 1, max);

      // èˆ‡å·²çœ‹éæª¢æŸ¥
      const watched = new Set(a.watched||[]);
      const toAdd = [];
      const lo = Math.min(s,e), hi = Math.max(s,e);
      for(let i=lo;i<=hi;i++) toAdd.push(i);
      const dups = uniq(toAdd).filter(x=>watched.has(x));
      if(dups.length){
        el.warn.textContent = `ä»¥ä¸‹é›†æ•¸å·²è¨˜éŒ„éï¼š${dups.join(', ')}ï¼Œä¸æœƒåŠ å…¥ã€‚`;
        return;
      }
      toAdd.forEach(n=>pending.add(n));
      renderPending();
    }

    async function saveLog(){
      el.warn.textContent=''; el.stat.textContent='';
      const a = currentAnime(); if(!a){ el.warn.textContent='å°šç„¡å‹•ç•«'; return; }
      const weekISO = el.week.value;
      const eps = Array.from(pending).sort((x,y)=>x-y);
      if(eps.length===0){ el.warn.textContent='è«‹å…ˆåŠ å…¥è‡³å°‘ä¸€å€‹é›†æ•¸'; return; }

      // å†æ¬¡é‡è¤‡æª¢æŸ¥
      const watched = new Set(a.watched||[]);
      const dups = eps.filter(x=>watched.has(x));
      if(dups.length){ el.warn.textContent=`ä»¥ä¸‹é›†æ•¸å·²è¨˜éŒ„éï¼š${dups.join(', ')}ï¼Œä¸æœƒä¸Šå‚³ã€‚`; return; }

      el.stat.textContent = 'ä¸Šå‚³ä¸­â€¦';
      try{
        await cloudAddLog(a.id, weekISO, eps);
        const fresh = await cloudGetAll();
        db = fresh; saveLocal(fresh);
        pending.clear(); onAnimeChange();
        el.stat.textContent = 'âœ… å·²å„²å­˜ï¼';
      }catch(e){
        console.error(e); el.stat.textContent='âŒ é›²ç«¯åŒæ­¥å¤±æ•—ï¼ˆç¨å¾Œå†è©¦ï¼‰';
      }
    }

    el.add.onclick = addRange;
    el.clr.onclick = ()=>{ pending.clear(); renderPending(); };
    el.save.onclick = saveLog;
    el.anime.onchange = onAnimeChange;

    (async function init(){
      try{ const fresh = await cloudGetAll(); db=fresh; saveLocal(fresh); }
      catch(e){ console.warn('é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬æ©Ÿ'); }
      buildWeeks(); buildAnimes();
    })();
  </script>
</body>
</html>
